<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="genindex.html" /><link rel="search" title="搜索" href="search.html" /><link rel="next" title="使用子进程" href="subprocesses.html" /><link rel="prev" title="使用套接字和流" href="networking.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>使用线程 - AnyIO 4.6.2 文档</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">AnyIO 4.6.2 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">AnyIO 4.6.2 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basics.html">基础知识</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">创建和管理任务</a></li>
<li class="toctree-l1"><a class="reference internal" href="cancellation.html">取消和超时</a></li>
<li class="toctree-l1"><a class="reference internal" href="synchronization.html">使用同步原语</a></li>
<li class="toctree-l1"><a class="reference internal" href="streams.html">流</a></li>
<li class="toctree-l1"><a class="reference internal" href="typedattrs.html">使用类型化属性</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">使用套接字和流</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">使用线程</a></li>
<li class="toctree-l1"><a class="reference internal" href="subprocesses.html">使用子进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="fileio.html">异步文件 I/O 支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="signals.html">接收操作系统信号</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">使用 AnyIO 进行测试</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API 参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html">从 AnyIO 3 迁移到 AnyIO 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html#anyio-2-anyio-3">从 AnyIO 2 迁移到 AnyIO 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">获取帮助</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html#id2">报告错误</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">为 AnyIO 做出贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="versionhistory.html">版本历史</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/blob/sync-docs/cn_docs/threads.rst?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/edit/sync-docs/cn_docs/threads.rst" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="id1">
<h1>使用线程<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h1>
<p><strong>Working with threads</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p>实际的异步应用程序有时需要执行网络、文件或计算开销大的操作。这些操作通常会阻塞异步事件循环，导致性能问题。解决方案是将此类代码放在 <em>工作线程(worker threads)</em> 中运行。使用工作线程可以让事件循环继续运行其他任务，同时工作线程运行阻塞调用。</p>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>Practical asynchronous applications occasionally need to run network, file or
computationally expensive operations. Such operations would normally block the
asynchronous event loop, leading to performance issues. The solution is to run such code
in <em>worker threads</em>. Using worker threads lets the event loop continue running other
tasks while the worker thread runs the blocking call.</p>
</div></div>
<section id="id2">
<h2>在工作线程中运行函数<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p><strong>Running a function in a worker thread</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><p>在工作线程中运行一个（同步的）可调用对象:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">to_thread</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">to_thread</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>默认情况下，当任务在等待工作线程完成时，它们会被保护免受取消。您可以传递 <code class="docutils literal notranslate"><span class="pre">cancellable=True</span></code> 参数来允许这些任务被取消。然而，请注意，线程仍然会继续运行——只是它的结果将被忽略。</p>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><p>To run a (synchronous) callable in a worker thread:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">to_thread</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">to_thread</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>By default, tasks are shielded from cancellation while they are waiting for a worker
thread to finish. You can pass the <code class="docutils literal notranslate"><span class="pre">cancellable=True</span></code> parameter to allow such tasks to
be cancelled. Note, however, that the thread will still continue running – only its
outcome will be ignored.</p>
</div></div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="subprocesses.html#runinprocess"><span class="std std-ref">在工作进程中运行函数</span></a></p>
</div>
</section>
<section id="id3">
<h2>从工作线程调用异步代码<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p><strong>Calling asynchronous code from a worker thread</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><p>如果您需要从工作线程调用一个协程函数，可以这样做:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">from_thread</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">to_thread</span><span class="p">,</span> <span class="n">run</span>


<span class="k">def</span> <span class="nf">blocking_function</span><span class="p">():</span>
    <span class="n">from_thread</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">sleep</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">to_thread</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">blocking_function</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>必须使用 <a class="reference internal" href="api.html#anyio.to_thread.run_sync" title="anyio.to_thread.run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_sync()</span></code></a> 启动工作线程，才能使此功能正常工作。</p>
</div>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><p>If you need to call a coroutine function from a worker thread, you can do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">from_thread</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">to_thread</span><span class="p">,</span> <span class="n">run</span>


<span class="k">def</span> <span class="nf">blocking_function</span><span class="p">():</span>
    <span class="n">from_thread</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">sleep</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">await</span> <span class="n">to_thread</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">blocking_function</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The worker thread must have been spawned using <a class="reference internal" href="api.html#anyio.to_thread.run_sync" title="anyio.to_thread.run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_sync()</span></code></a> for</p>
</div>
<p>this to work.</p>
</div></div>
</section>
<section id="id4">
<h2>从工作线程调用同步代码<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h2>
<p><strong>Calling synchronous code from a worker thread</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><p>有时您可能需要从工作线程在事件循环线程中调用同步代码。常见的情况包括设置异步事件或将数据发送到内存对象流。因为这些方法不是线程安全的，所以您需要安排它们在事件循环线程中调用，使用 <a class="reference internal" href="api.html#anyio.from_thread.run_sync" title="anyio.from_thread.run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_sync()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">from_thread</span><span class="p">,</span> <span class="n">to_thread</span><span class="p">,</span> <span class="n">run</span>

<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">from_thread</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">to_thread</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><p>Occasionally you may need to call synchronous code in the event loop thread from a
worker thread. Common cases include setting asynchronous events or sending data to a
memory object stream. Because these methods aren't thread safe, you need to arrange them
to be called inside the event loop thread using <a class="reference internal" href="api.html#anyio.from_thread.run_sync" title="anyio.from_thread.run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_sync()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">from_thread</span><span class="p">,</span> <span class="n">to_thread</span><span class="p">,</span> <span class="n">run</span>

<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">from_thread</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="k">await</span> <span class="n">to_thread</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id5">
<h2>从外部线程调用异步代码<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h2>
<p><strong>Calling asynchronous code from an external thread</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><p>如果您需要从一个不是由事件循环生成的工作线程中运行异步代码，您需要一个 <em>阻塞门户(blocking portal)</em> 。这个门户需要在事件循环线程中获取。</p>
<p>一种方法是使用 <a class="reference internal" href="api.html#anyio.from_thread.start_blocking_portal" title="anyio.from_thread.start_blocking_portal"><code class="xref py py-class docutils literal notranslate"><span class="pre">start_blocking_portal</span></code></a> 启动一个新事件循环并获取门户（它的参数与 <a class="reference internal" href="api.html#anyio.run" title="anyio.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">run()</span></code></a> 基本相同）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">start_blocking_portal</span>


<span class="k">with</span> <span class="n">start_blocking_portal</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s1">&#39;trio&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">portal</span><span class="p">:</span>
    <span class="n">portal</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>如果您已经有一个正在运行的事件循环，并希望允许外部线程访问，您可以直接创建一个 <a class="reference internal" href="api.html#anyio.from_thread.BlockingPortal" title="anyio.from_thread.BlockingPortal"><code class="xref py py-class docutils literal notranslate"><span class="pre">BlockingPortal</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">BlockingPortal</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">BlockingPortal</span><span class="p">()</span> <span class="k">as</span> <span class="n">portal</span><span class="p">:</span>
        <span class="c1"># ...将门户交给外部线程...</span>
        <span class="k">await</span> <span class="n">portal</span><span class="o">.</span><span class="n">sleep_until_stopped</span><span class="p">()</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><p>If you need to run async code from a thread that is not a worker thread spawned by the
event loop, you need a <em>blocking portal</em>. This needs to be obtained from within the
event loop thread.</p>
<p>One way to do this is to start a new event loop with a portal, using
<a class="reference internal" href="api.html#anyio.from_thread.start_blocking_portal" title="anyio.from_thread.start_blocking_portal"><code class="xref py py-class docutils literal notranslate"><span class="pre">start_blocking_portal</span></code></a> (which takes mostly the same arguments as
<a class="reference internal" href="api.html#anyio.run" title="anyio.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">run()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">start_blocking_portal</span>


<span class="k">with</span> <span class="n">start_blocking_portal</span><span class="p">(</span><span class="n">backend</span><span class="o">=</span><span class="s1">&#39;trio&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">portal</span><span class="p">:</span>
    <span class="n">portal</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>If you already have an event loop running and wish to grant access to external threads,
you can create a <a class="reference internal" href="api.html#anyio.from_thread.BlockingPortal" title="anyio.from_thread.BlockingPortal"><code class="xref py py-class docutils literal notranslate"><span class="pre">BlockingPortal</span></code></a> directly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">BlockingPortal</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">BlockingPortal</span><span class="p">()</span> <span class="k">as</span> <span class="n">portal</span><span class="p">:</span>
        <span class="c1"># ...hand off the portal to external threads...</span>
        <span class="k">await</span> <span class="n">portal</span><span class="o">.</span><span class="n">sleep_until_stopped</span><span class="p">()</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id6">
<h2>从工作线程生成任务<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h2>
<p><strong>Spawning tasks from worker threads</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-5-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-5-5-0" name="5-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-5-5-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-5-5-1" name="5-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-5-5-0" class="sphinx-tabs-panel" id="panel-5-5-0" name="5-0" role="tabpanel" tabindex="0"><p>当您需要生成一个在后台运行的任务时，可以使用 <a class="reference internal" href="api.html#anyio.from_thread.BlockingPortal.start_task_soon" title="anyio.from_thread.BlockingPortal.start_task_soon"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start_task_soon()</span></code></a> 来实现:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">as_completed</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">start_blocking_portal</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">long_running_task</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1"> running...&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Task </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1"> return value&#39;</span>


<span class="k">with</span> <span class="n">start_blocking_portal</span><span class="p">()</span> <span class="k">as</span> <span class="n">portal</span><span class="p">:</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">portal</span><span class="o">.</span><span class="n">start_task_soon</span><span class="p">(</span><span class="n">long_running_task</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
</pre></div>
</div>
<p>通过取消返回的 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/concurrent.futures.html#concurrent.futures.Future" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Future</span></code></a> 来取消这种方式生成的任务。</p>
<p>阻塞门户还提供了一个与 <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start" title="anyio.abc.TaskGroup.start"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start()</span></code></a> 类似的方法 <a class="reference internal" href="api.html#anyio.from_thread.BlockingPortal.start_task" title="anyio.from_thread.BlockingPortal.start_task"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start_task()</span></code></a>，它与其对等方法一样，通过调用 <code class="docutils literal notranslate"><span class="pre">task_status.started()</span></code> 等待可调用对象信号准备就绪:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">TASK_STATUS_IGNORED</span>
<span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">start_blocking_portal</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">service_task</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">task_status</span><span class="o">=</span><span class="n">TASK_STATUS_IGNORED</span><span class="p">):</span>
    <span class="n">task_status</span><span class="o">.</span><span class="n">started</span><span class="p">(</span><span class="s1">&#39;STARTED&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;DONE&#39;</span>


<span class="k">with</span> <span class="n">start_blocking_portal</span><span class="p">()</span> <span class="k">as</span> <span class="n">portal</span><span class="p">:</span>
    <span class="n">future</span><span class="p">,</span> <span class="n">start_value</span> <span class="o">=</span> <span class="n">portal</span><span class="o">.</span><span class="n">start_task</span><span class="p">(</span><span class="n">service_task</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task has started with value&#39;</span><span class="p">,</span> <span class="n">start_value</span><span class="p">)</span>

    <span class="n">return_value</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task has finished with return value&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-5-5-1" class="sphinx-tabs-panel" hidden="true" id="panel-5-5-1" name="5-1" role="tabpanel" tabindex="0"><p>When you need to spawn a task to be run in the background, you can do so using
<a class="reference internal" href="api.html#anyio.from_thread.BlockingPortal.start_task_soon" title="anyio.from_thread.BlockingPortal.start_task_soon"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start_task_soon()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">as_completed</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">start_blocking_portal</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">long_running_task</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Task </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1"> running...&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;Task </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1"> return value&#39;</span>


<span class="k">with</span> <span class="n">start_blocking_portal</span><span class="p">()</span> <span class="k">as</span> <span class="n">portal</span><span class="p">:</span>
    <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">portal</span><span class="o">.</span><span class="n">start_task_soon</span><span class="p">(</span><span class="n">long_running_task</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
</pre></div>
</div>
<p>Cancelling tasks spawned this way can be done by cancelling the returned
<a class="reference external" href="https://docs.python.org/zh-cn/3/library/concurrent.futures.html#concurrent.futures.Future" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">Future</span></code></a>.</p>
<p>Blocking portals also have a method similar to
<a class="reference internal" href="api.html#anyio.abc.TaskGroup.start" title="anyio.abc.TaskGroup.start"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start()</span></code></a>:
<a class="reference internal" href="api.html#anyio.from_thread.BlockingPortal.start_task" title="anyio.from_thread.BlockingPortal.start_task"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start_task()</span></code></a> which, like its counterpart, waits for the callable
to signal readiness by calling <code class="docutils literal notranslate"><span class="pre">task_status.started()</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">TASK_STATUS_IGNORED</span>
<span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">start_blocking_portal</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">service_task</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">task_status</span><span class="o">=</span><span class="n">TASK_STATUS_IGNORED</span><span class="p">):</span>
    <span class="n">task_status</span><span class="o">.</span><span class="n">started</span><span class="p">(</span><span class="s1">&#39;STARTED&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="s1">&#39;DONE&#39;</span>


<span class="k">with</span> <span class="n">start_blocking_portal</span><span class="p">()</span> <span class="k">as</span> <span class="n">portal</span><span class="p">:</span>
    <span class="n">future</span><span class="p">,</span> <span class="n">start_value</span> <span class="o">=</span> <span class="n">portal</span><span class="o">.</span><span class="n">start_task</span><span class="p">(</span><span class="n">service_task</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task has started with value&#39;</span><span class="p">,</span> <span class="n">start_value</span><span class="p">)</span>

    <span class="n">return_value</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task has finished with return value&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id7">
<h2>从工作线程使用异步上下文管理器<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h2>
<p><strong>Using asynchronous context managers from worker threads</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-6-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-6-6-0" name="6-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-6-6-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-6-6-1" name="6-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-6-6-0" class="sphinx-tabs-panel" id="panel-6-6-0" name="6-0" role="tabpanel" tabindex="0"><p>您可以使用 <a class="reference internal" href="api.html#anyio.from_thread.BlockingPortal.wrap_async_context_manager" title="anyio.from_thread.BlockingPortal.wrap_async_context_manager"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wrap_async_context_manager()</span></code></a> 将异步上下文管理器包装为同步上下文管理器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">start_blocking_portal</span>


<span class="k">class</span> <span class="nc">AsyncContextManager</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;entering&#39;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;exiting with&#39;</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">)</span>


<span class="n">async_cm</span> <span class="o">=</span> <span class="n">AsyncContextManager</span><span class="p">()</span>
<span class="k">with</span> <span class="n">start_blocking_portal</span><span class="p">()</span> <span class="k">as</span> <span class="n">portal</span><span class="p">,</span> <span class="n">portal</span><span class="o">.</span><span class="n">wrap_async_context_manager</span><span class="p">(</span><span class="n">async_cm</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;inside the context manager block&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>不能在事件循环线程中的同步回调中使用包装的异步上下文管理器。</p>
</div>
</div><div aria-labelledby="tab-6-6-1" class="sphinx-tabs-panel" hidden="true" id="panel-6-6-1" name="6-1" role="tabpanel" tabindex="0"><p>You can use <a class="reference internal" href="api.html#anyio.from_thread.BlockingPortal.wrap_async_context_manager" title="anyio.from_thread.BlockingPortal.wrap_async_context_manager"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wrap_async_context_manager()</span></code></a> to wrap an asynchronous
context managers as a synchronous one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">start_blocking_portal</span>


<span class="k">class</span> <span class="nc">AsyncContextManager</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;entering&#39;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;exiting with&#39;</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">)</span>


<span class="n">async_cm</span> <span class="o">=</span> <span class="n">AsyncContextManager</span><span class="p">()</span>
<span class="k">with</span> <span class="n">start_blocking_portal</span><span class="p">()</span> <span class="k">as</span> <span class="n">portal</span><span class="p">,</span> <span class="n">portal</span><span class="o">.</span><span class="n">wrap_async_context_manager</span><span class="p">(</span><span class="n">async_cm</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;inside the context manager block&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>You cannot use wrapped async context managers in synchronous callbacks inside</p>
</div>
<p>the event loop thread.</p>
</div></div>
</section>
<section id="id8">
<h2>上下文传播<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h2>
<p><strong>Context propagation</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-7-7-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-7-7-0" name="7-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-7-7-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-7-7-1" name="7-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-7-7-0" class="sphinx-tabs-panel" id="panel-7-7-0" name="7-0" role="tabpanel" tabindex="0"><p>在工作线程中运行函数时，当前上下文会被复制到工作线程。因此，任务中可用的任何上下文变量也将在线程中运行的代码中可用。与上下文变量一样，对它们所做的任何更改将不会传播回调用的异步任务。</p>
<p>从工作线程调用异步代码时，上下文再次被复制到事件循环线程中调用目标函数的任务。</p>
</div><div aria-labelledby="tab-7-7-1" class="sphinx-tabs-panel" hidden="true" id="panel-7-7-1" name="7-1" role="tabpanel" tabindex="0"><p>When running functions in worker threads, the current context is copied to the worker
thread. Therefore any context variables available on the task will also be available to
the code running on the thread. As always with context variables, any changes made to
them will not propagate back to the calling asynchronous task.</p>
<p>When calling asynchronous code from worker threads, context is again copied to the task
that calls the target function in the event loop thread.</p>
</div></div>
</section>
<section id="id9">
<h2>调整默认最大工作线程数<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h2>
<p><strong>Adjusting the default maximum worker thread count</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-8-8-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-8-8-0" name="8-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-8-8-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-8-8-1" name="8-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-8-8-0" class="sphinx-tabs-panel" id="panel-8-8-0" name="8-0" role="tabpanel" tabindex="0"><p>默认的 AnyIO 工作线程限制器值为 <strong>40</strong>，这意味着任何没有显式 <code class="docutils literal notranslate"><span class="pre">limiter</span></code> 参数的 <a class="reference internal" href="api.html#anyio.to_thread.run_sync" title="anyio.to_thread.run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">to_thread.run_sync()</span></code></a> 调用将最多会启动 40 个线程。您可以像这样调整此限制：</p>
<blockquote>
<div><p>from anyio import to_thread</p>
<dl class="simple">
<dt>async def foo():</dt><dd><p># 设置最大工作线程数为 60
to_thread.current_default_thread_limiter().total_tokens = 60</p>
</dd>
</dl>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>AnyIO 的默认线程池限制器不会影响 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio.html#module-asyncio" title="（在 Python v3.13）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code></a> 中的默认线程池执行器。</p>
</div>
</div><div aria-labelledby="tab-8-8-1" class="sphinx-tabs-panel" hidden="true" id="panel-8-8-1" name="8-1" role="tabpanel" tabindex="0"><p>The default AnyIO worker thread limiter has a value of <strong>40</strong>, meaning that any calls
to <a class="reference internal" href="api.html#anyio.to_thread.run_sync" title="anyio.to_thread.run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">to_thread.run_sync()</span></code></a> without an explicit <code class="docutils literal notranslate"><span class="pre">limiter</span></code> argument will cause a
maximum of 40 threads to be spawned. You can adjust this limit like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">to_thread</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="c1"># Set the maximum number of worker threads to 60</span>
    <span class="n">to_thread</span><span class="o">.</span><span class="n">current_default_thread_limiter</span><span class="p">()</span><span class="o">.</span><span class="n">total_tokens</span> <span class="o">=</span> <span class="mi">60</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>AnyIO's default thread pool limiter does not affect the default thread pool
executor on <a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio.html#module-asyncio" title="（在 Python v3.13）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">asyncio</span></code></a>.</p>
</div>
</div></div>
</section>
<section id="id10">
<h2>对工作线程中的取消做出反应<a class="headerlink" href="#id10" title="Link to this heading">¶</a></h2>
<p><strong>Reacting to cancellation in worker threads</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-9-9-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-9-9-0" name="9-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-9-9-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-9-9-1" name="9-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-9-9-0" class="sphinx-tabs-panel" id="panel-9-9-0" name="9-0" role="tabpanel" tabindex="0"><p>虽然 Python 没有机制来取消在线程中运行的代码，但 AnyIO 提供了一种机制，允许用户代码自愿检查宿主任务的作用域是否已被取消，如果已取消，则引发取消异常。这可以通过简单地调用 <a class="reference internal" href="api.html#anyio.from_thread.check_cancelled" title="anyio.from_thread.check_cancelled"><code class="xref py py-func docutils literal notranslate"><span class="pre">from_thread.check_cancelled()</span></code></a> 来实现：</p>
<blockquote>
<div><p>from anyio import to_thread, from_thread</p>
<dl class="simple">
<dt>def sync_function():</dt><dd><dl class="simple">
<dt>while True:</dt><dd><p>from_thread.check_cancelled()
print(&quot;还没有取消&quot;)
sleep(1)</p>
</dd>
</dl>
</dd>
<dt>async def foo():</dt><dd><dl class="simple">
<dt>with move_on_after(3):</dt><dd><p>await to_thread.run_sync(sync_function)</p>
</dd>
</dl>
</dd>
</dl>
</div></blockquote>
</div><div aria-labelledby="tab-9-9-1" class="sphinx-tabs-panel" hidden="true" id="panel-9-9-1" name="9-1" role="tabpanel" tabindex="0"><p>While there is no mechanism in Python to cancel code running in a thread, AnyIO provides a
mechanism that allows user code to voluntarily check if the host task's scope has been cancelled,
and if it has, raise a cancellation exception. This can be done by simply calling
<a class="reference internal" href="api.html#anyio.from_thread.check_cancelled" title="anyio.from_thread.check_cancelled"><code class="xref py py-func docutils literal notranslate"><span class="pre">from_thread.check_cancelled()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">to_thread</span><span class="p">,</span> <span class="n">from_thread</span>

<span class="k">def</span> <span class="nf">sync_function</span><span class="p">():</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">from_thread</span><span class="o">.</span><span class="n">check_cancelled</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Not cancelled yet&quot;</span><span class="p">)</span>
        <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">with</span> <span class="n">move_on_after</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">await</span> <span class="n">to_thread</span><span class="o">.</span><span class="n">run_sync</span><span class="p">(</span><span class="n">sync_function</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id11">
<h2>按需共享阻塞门户<a class="headerlink" href="#id11" title="Link to this heading">¶</a></h2>
<p><strong>Sharing a blocking portal on demand</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-10-10-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-10-10-0" name="10-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-10-10-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-10-10-1" name="10-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-10-10-0" class="sphinx-tabs-panel" id="panel-10-10-0" name="10-0" role="tabpanel" tabindex="0"><p>如果您正在构建一个需要按需启动阻塞门户的同步 API，您可能需要比每次调用都启动一个阻塞门户更高效的解决方案。为此，您可以使用 <code class="xref py py-class docutils literal notranslate"><span class="pre">BlockingPortalProvider</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">BlockingPortalProvider</span>

<span class="k">class</span> <span class="nc">MyAPI</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">async_obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_async_obj</span> <span class="o">=</span> <span class="n">async_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_portal_provider</span> <span class="o">=</span> <span class="n">BlockingPortalProvider</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">do_stuff</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_portal_provider</span> <span class="k">as</span> <span class="n">portal</span><span class="p">:</span>
            <span class="n">portal</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">async_obj</span><span class="o">.</span><span class="n">do_async_stuff</span><span class="p">)</span>
</pre></div>
</div>
<p>现在，无论有多少线程同时调用 <code class="docutils literal notranslate"><span class="pre">MyAPI</span></code> 实例上的 <code class="docutils literal notranslate"><span class="pre">do_stuff()</span></code> 方法，都会使用相同的阻塞门户来处理内部的异步调用。很容易看出，这比每个调用都启动自己的阻塞门户要高效得多。</p>
</div><div aria-labelledby="tab-10-10-1" class="sphinx-tabs-panel" hidden="true" id="panel-10-10-1" name="10-1" role="tabpanel" tabindex="0"><p>If you're building a synchronous API that needs to start a blocking portal on demand,
you might need a more efficient solution than just starting a blocking portal for each
call. To that end, you can use <code class="xref py py-class docutils literal notranslate"><span class="pre">BlockingPortalProvider</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">BlockingPortalProvider</span>

<span class="k">class</span> <span class="nc">MyAPI</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">async_obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_async_obj</span> <span class="o">=</span> <span class="n">async_obj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_portal_provider</span> <span class="o">=</span> <span class="n">BlockingPortalProvider</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">do_stuff</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_portal_provider</span> <span class="k">as</span> <span class="n">portal</span><span class="p">:</span>
            <span class="n">portal</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">async_obj</span><span class="o">.</span><span class="n">do_async_stuff</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, no matter how many threads call the <code class="docutils literal notranslate"><span class="pre">do_stuff()</span></code> method on a <code class="docutils literal notranslate"><span class="pre">MyAPI</span></code> instance
at the same time, the same blocking portal will be used to handle the async calls
inside. It's easy to see that this is much more efficient than having each call spawn
its own blocking portal.</p>
</div></div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="subprocesses.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">使用子进程</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="networking.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">使用套接字和流</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2018, Alex Grönholm
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/hellowac/anyio-zh-cn" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">使用线程</a><ul>
<li><a class="reference internal" href="#id2">在工作线程中运行函数</a></li>
<li><a class="reference internal" href="#id3">从工作线程调用异步代码</a></li>
<li><a class="reference internal" href="#id4">从工作线程调用同步代码</a></li>
<li><a class="reference internal" href="#id5">从外部线程调用异步代码</a></li>
<li><a class="reference internal" href="#id6">从工作线程生成任务</a></li>
<li><a class="reference internal" href="#id7">从工作线程使用异步上下文管理器</a></li>
<li><a class="reference internal" href="#id8">上下文传播</a></li>
<li><a class="reference internal" href="#id9">调整默认最大工作线程数</a></li>
<li><a class="reference internal" href="#id10">对工作线程中的取消做出反应</a></li>
<li><a class="reference internal" href="#id11">按需共享阻塞门户</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=b0668c51"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/translations.js?v=beaddf03"></script>
    <script src="_static/tabs.js?v=3030b3cb"></script>
    </body>
</html>