<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="genindex.html" /><link rel="search" title="搜索" href="search.html" /><link rel="next" title="使用线程" href="threads.html" /><link rel="prev" title="使用类型化属性" href="typedattrs.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>使用套接字和流 - AnyIO 4.6.2 文档</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">AnyIO 4.6.2 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">AnyIO 4.6.2 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basics.html">基础知识</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">创建和管理任务</a></li>
<li class="toctree-l1"><a class="reference internal" href="cancellation.html">取消和超时</a></li>
<li class="toctree-l1"><a class="reference internal" href="synchronization.html">使用同步原语</a></li>
<li class="toctree-l1"><a class="reference internal" href="streams.html">流</a></li>
<li class="toctree-l1"><a class="reference internal" href="typedattrs.html">使用类型化属性</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">使用套接字和流</a></li>
<li class="toctree-l1"><a class="reference internal" href="threads.html">使用线程</a></li>
<li class="toctree-l1"><a class="reference internal" href="subprocesses.html">使用子进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="fileio.html">异步文件 I/O 支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="signals.html">接收操作系统信号</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">使用 AnyIO 进行测试</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API 参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html">从 AnyIO 3 迁移到 AnyIO 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html#anyio-2-anyio-3">从 AnyIO 2 迁移到 AnyIO 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">获取帮助</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html#id2">报告错误</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">为 AnyIO 做出贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="versionhistory.html">版本历史</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/blob/sync-docs/cn_docs/networking.rst?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/edit/sync-docs/cn_docs/networking.rst" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="id1">
<h1>使用套接字和流<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h1>
<p><strong>Using sockets and streams</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p>网络功能可以说是任何异步库中最重要的部分。AnyIO 在其支持的每个后端提供的低级原语之上, 包含了自己实现的高层网络功能。</p>
<p>目前, AnyIO 提供以下网络功能：</p>
<ul class="simple">
<li><p>TCP 套接字(客户端 + 服务器)</p></li>
<li><p>UNIX 域套接字(客户端 + 服务器)</p></li>
<li><p>UDP 套接字</p></li>
<li><p>UNIX 数据报套接字</p></li>
</ul>
<p>目前尚不支持更为特殊的网络形式, 如原始套接字和 SCTP。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>与标准 BSD 套接字接口和大多数其他网络库不同, AnyIO(从 2.0 版本起)通过引发 <a class="reference internal" href="api.html#anyio.EndOfStream" title="anyio.EndOfStream"><code class="xref py py-exc docutils literal notranslate"><span class="pre">EndOfStream</span></code></a> 异常来标示任何流的结束, 而不是返回一个空的字节对象。</p>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>Networking capabilities are arguably the most important part of any asynchronous
library. AnyIO contains its own high level implementation of networking on top of low
level primitives offered by each of its supported backends.</p>
<p>Currently AnyIO offers the following networking functionality:</p>
<ul class="simple">
<li><p>TCP sockets (client + server)</p></li>
<li><p>UNIX domain sockets (client + server)</p></li>
<li><p>UDP sockets</p></li>
<li><p>UNIX datagram sockets</p></li>
</ul>
<p>More exotic forms of networking such as raw sockets and SCTP are currently not
supported.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>Unlike the standard BSD sockets interface and most other networking
libraries, AnyIO (from 2.0 onwards) signals the end of any stream by raising the
<a class="reference internal" href="api.html#anyio.EndOfStream" title="anyio.EndOfStream"><code class="xref py py-exc docutils literal notranslate"><span class="pre">EndOfStream</span></code></a> exception instead of returning an empty bytes object.</p>
</div>
</div></div>
<section id="tcp">
<h2>使用 TCP 套接字<a class="headerlink" href="#tcp" title="Link to this heading">¶</a></h2>
<p><strong>Working with TCP sockets</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><p>TCP(传输控制协议)是互联网上最常用的协议。它允许连接到远程主机的端口, 并以可靠的方式发送和接收数据。</p>
<p>要连接到某个地方的监听 TCP 套接字, 可以使用 <a class="reference internal" href="api.html#anyio.connect_tcp" title="anyio.connect_tcp"><code class="xref py py-func docutils literal notranslate"><span class="pre">connect_tcp()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">connect_tcp</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">connect_tcp</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">,</span> <span class="mi">1234</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Client</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>为了方便, 您还可以使用 <a class="reference internal" href="api.html#anyio.connect_tcp" title="anyio.connect_tcp"><code class="xref py py-func docutils literal notranslate"><span class="pre">connect_tcp()</span></code></a> 在连接后与对端建立 TLS 会话, 方法是传递 <code class="docutils literal notranslate"><span class="pre">tls=True</span></code>, 或为 <code class="docutils literal notranslate"><span class="pre">ssl_context</span></code> 或 <code class="docutils literal notranslate"><span class="pre">tls_hostname</span></code> 传递一个非空值。</p>
<p>要接收传入的 TCP 连接, 首先使用 <a class="reference internal" href="api.html#anyio.create_tcp_listener" title="anyio.create_tcp_listener"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_tcp_listener()</span></code></a> 创建一个 TCP 监听器, 并在其上调用 <a class="reference internal" href="api.html#anyio.abc.Listener.serve" title="anyio.abc.Listener.serve"><code class="xref py py-meth docutils literal notranslate"><span class="pre">serve()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_tcp_listener</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_tcp_listener</span><span class="p">(</span><span class="n">local_port</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">listener</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>有关更多信息, 请参阅 <a class="reference internal" href="streams.html#tls"><span class="std std-ref">TLS 流</span></a> 部分。</p>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><p>TCP (Transmission Control Protocol) is the most commonly used protocol on the Internet.
It allows one to connect to a port on a remote host and send and receive data in a
reliable manner.</p>
<p>To connect to a listening TCP socket somewhere, you can use <a class="reference internal" href="api.html#anyio.connect_tcp" title="anyio.connect_tcp"><code class="xref py py-func docutils literal notranslate"><span class="pre">connect_tcp()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">connect_tcp</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">connect_tcp</span><span class="p">(</span><span class="s1">&#39;hostname&#39;</span><span class="p">,</span> <span class="mi">1234</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Client</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>As a convenience, you can also use <a class="reference internal" href="api.html#anyio.connect_tcp" title="anyio.connect_tcp"><code class="xref py py-func docutils literal notranslate"><span class="pre">connect_tcp()</span></code></a> to establish a TLS session with
the peer after connection, by passing <code class="docutils literal notranslate"><span class="pre">tls=True</span></code> or by passing a nonempty value for
either <code class="docutils literal notranslate"><span class="pre">ssl_context</span></code> or <code class="docutils literal notranslate"><span class="pre">tls_hostname</span></code>.</p>
<p>To receive incoming TCP connections, you first create a TCP listener with
<a class="reference internal" href="api.html#anyio.create_tcp_listener" title="anyio.create_tcp_listener"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_tcp_listener()</span></code></a> and call <a class="reference internal" href="api.html#anyio.abc.Listener.serve" title="anyio.abc.Listener.serve"><code class="xref py py-meth docutils literal notranslate"><span class="pre">serve()</span></code></a> on it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_tcp_listener</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_tcp_listener</span><span class="p">(</span><span class="n">local_port</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">listener</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>See the section on <a class="reference internal" href="streams.html#tls"><span class="std std-ref">TLS 流</span></a> for more information.</p>
</div></div>
</section>
<section id="unix">
<h2>使用 UNIX 套接字<a class="headerlink" href="#unix" title="Link to this heading">¶</a></h2>
<p><strong>Working with UNIX sockets</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><p>UNIX 域套接字是 UNIX 类操作系统上的一种进程间通信形式。它们不能用于连接到远程主机, 并且在 Windows 上无法使用。</p>
<p>UNIX 域套接字的 API 与 TCP 套接字的 API 类似, 不同之处在于, 它使用的是文件系统路径, 而不是主机/端口组合。</p>
<p>这是从 TCP 示例转换为使用 UNIX 套接字的客户端代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">connect_unix</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">connect_unix</span><span class="p">(</span><span class="s1">&#39;/tmp/mysock&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Client</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>监听器代码如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_unix_listener</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_unix_listener</span><span class="p">(</span><span class="s1">&#39;/tmp/mysock&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">listener</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>UNIX 套接字监听器不会删除它创建的套接字, 因此您可能需要手动删除它们。</p>
</div>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><p>UNIX domain sockets are a form of interprocess communication on UNIX-like operating
systems. They cannot be used to connect to remote hosts and do not work on Windows.</p>
<p>The API for UNIX domain sockets is much like the one for TCP sockets, except that
instead of host/port combinations, you use file system paths.</p>
<p>This is what the client from the TCP example looks like when converted to use UNIX
sockets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">connect_unix</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">connect_unix</span><span class="p">(</span><span class="s1">&#39;/tmp/mysock&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Client</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>And the listener:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_unix_listener</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_unix_listener</span><span class="p">(</span><span class="s1">&#39;/tmp/mysock&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">listener</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The UNIX socket listener does not remove the socket it creates, so you may</p>
</div>
<p>need to delete them manually.</p>
</div></div>
<section id="id2">
<h3>发送和接收文件描述符<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h3>
<p><strong>Sending and receiving file descriptors</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><p>UNIX 套接字可以用于将打开的文件描述符(套接字和文件)传递给另一个进程。接收端可以使用 <cite>os.fdopen</cite> 或 <cite>socket.socket</cite> 来分别获取可用的文件或套接字对象。</p>
<p>以下是一个示例, 客户端连接到 UNIX 套接字服务器并接收服务器上打开的文件的描述符, 读取文件内容, 然后将其打印到标准输出。</p>
<p>客户端代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">connect_unix</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">connect_unix</span><span class="p">(</span><span class="s1">&#39;/tmp/mysock&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">fds</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive_fds</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>服务器代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_unix_listener</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send_fds</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;this message is ignored&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">file</span><span class="p">])</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_unix_listener</span><span class="p">(</span><span class="s1">&#39;/tmp/mysock&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">listener</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/tmp/examplefile&#39;</span><span class="p">)</span>
<span class="n">path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s1">&#39;Test file&#39;</span><span class="p">)</span>
<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><p>UNIX sockets can be used to pass open file descriptors (sockets and files) to another
process. The receiving end can then use either <a class="reference external" href="https://docs.python.org/zh-cn/3/library/os.html#os.fdopen" title="（在 Python v3.13）"><code class="xref py py-func docutils literal notranslate"><span class="pre">os.fdopen()</span></code></a> or
<a class="reference external" href="https://docs.python.org/zh-cn/3/library/socket.html#socket.socket" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">socket.socket</span></code></a> to get a usable file or socket object, respectively.</p>
<p>The following is an example where a client connects to a UNIX socket server and receives
the descriptor of a file opened on the server, reads the contents of the file and then
prints them on standard output.</p>
<p>Client:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">connect_unix</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">connect_unix</span><span class="p">(</span><span class="s1">&#39;/tmp/mysock&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">fds</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive_fds</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="n">fds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>Server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_unix_listener</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send_fds</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;this message is ignored&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">file</span><span class="p">])</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="k">await</span> <span class="n">create_unix_listener</span><span class="p">(</span><span class="s1">&#39;/tmp/mysock&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">listener</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;/tmp/examplefile&#39;</span><span class="p">)</span>
<span class="n">path</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s1">&#39;Test file&#39;</span><span class="p">)</span>
<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
</section>
<section id="udp">
<h2>使用 UDP 套接字<a class="headerlink" href="#udp" title="Link to this heading">¶</a></h2>
<p><strong>Working with UDP sockets</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><p>UDP(用户数据报协议)是一种通过网络发送数据包的方式, 不具有连接、重试或错误纠正等特性。</p>
<p>例如, 如果你想创建一个 UDP &quot;hello&quot; 服务, 该服务只读取一个数据包, 然后向发送方发送一个数据包, 内容前面加上 &quot;Hello, &quot;, 你可以这样做:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_udp_socket</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">create_udp_socket</span><span class="p">(</span>
        <span class="n">family</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">local_port</span><span class="o">=</span><span class="mi">1234</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">udp</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">packet</span><span class="p">,</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="ow">in</span> <span class="n">udp</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">udp</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, &#39;</span> <span class="o">+</span> <span class="n">packet</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果你在本地机器上测试, 或者不知道使用哪个协议族, 可以考虑在上述示例中将 <code class="docutils literal notranslate"><span class="pre">family=socket.AF_INET</span></code> 替换为 <code class="docutils literal notranslate"><span class="pre">local_host='localhost'</span></code> 。</p>
</div>
<p>如果你的用例涉及向单个目的地发送大量数据包, 你仍然可以将 UDP 套接字“连接”到特定的主机和端口, 以避免每次发送数据时都需要传递地址和端口:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_connected_udp_socket</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">create_connected_udp_socket</span><span class="p">(</span>
            <span class="n">remote_host</span><span class="o">=</span><span class="s1">&#39;hostname&#39;</span><span class="p">,</span> <span class="n">remote_port</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span> <span class="k">as</span> <span class="n">udp</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">udp</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hi there!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><p>UDP (User Datagram Protocol) is a way of sending packets over the network without
features like connections, retries or error correction.</p>
<p>For example, if you wanted to create a UDP &quot;hello&quot; service that just reads a packet and
then sends a packet to the sender with the contents prepended with &quot;Hello, &quot;, you would
do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_udp_socket</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">create_udp_socket</span><span class="p">(</span>
        <span class="n">family</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">local_port</span><span class="o">=</span><span class="mi">1234</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">udp</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">packet</span><span class="p">,</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span> <span class="ow">in</span> <span class="n">udp</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">udp</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, &#39;</span> <span class="o">+</span> <span class="n">packet</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>If you are testing on your local machine or don't know which family socket to</p>
</div>
<p>use, it is a good idea to replace <code class="docutils literal notranslate"><span class="pre">family=socket.AF_INET</span></code> by
<code class="docutils literal notranslate"><span class="pre">local_host='localhost'</span></code> in the previous example.</p>
<p>If your use case involves sending lots of packets to a single destination, you can still
&quot;connect&quot; your UDP socket to a specific host and port to avoid having to pass the
address and port every time you send data to the peer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_connected_udp_socket</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">create_connected_udp_socket</span><span class="p">(</span>
            <span class="n">remote_host</span><span class="o">=</span><span class="s1">&#39;hostname&#39;</span><span class="p">,</span> <span class="n">remote_port</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span> <span class="k">as</span> <span class="n">udp</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">udp</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hi there!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id3">
<h2>使用 UNIX 数据报套接字<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p><strong>Working with UNIX datagram sockets</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-5-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-5-5-0" name="5-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-5-5-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-5-5-1" name="5-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-5-5-0" class="sphinx-tabs-panel" id="panel-5-5-0" name="5-0" role="tabpanel" tabindex="0"><p>UNIX 数据报套接字是 UNIX 域套接字的一个子集, 区别在于, 虽然 UNIX 套接字实现了可靠的连续字节流通信(类似于 TCP), 但 UNIX 数据报套接字实现了数据包的通信(类似于 UDP)。</p>
<p>UNIX 数据报套接字的 API 模式类似于 UDP 套接字, 只是将主机/端口组合替换为文件系统路径——下面是使用 UNIX 数据报套接字编写的 UDP &quot;hello&quot; 服务示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_unix_datagram_socket</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">create_unix_datagram_socket</span><span class="p">(</span>
        <span class="n">local_path</span><span class="o">=</span><span class="s1">&#39;/tmp/mysock&#39;</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">unix_dg</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">packet</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">unix_dg</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">unix_dg</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, &#39;</span> <span class="o">+</span> <span class="n">packet</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>如果没有设置 <code class="docutils literal notranslate"><span class="pre">local_path</span></code>, UNIX 数据报套接字将绑定到一个没有名称的地址, 通常无法从其他 UNIX 数据报套接字接收数据报。</p>
</div>
<p>类似于 UDP 套接字, 如果你的用例涉及向单个目的地发送大量数据包, 你可以将 UNIX 数据报套接字“连接”到特定路径, 以避免每次发送数据时都需要传递路径:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_connected_unix_datagram_socket</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">create_connected_unix_datagram_socket</span><span class="p">(</span>
        <span class="n">remote_path</span><span class="o">=</span><span class="s1">&#39;/dev/log&#39;</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">unix_dg</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">unix_dg</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hi there!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-5-5-1" class="sphinx-tabs-panel" hidden="true" id="panel-5-5-1" name="5-1" role="tabpanel" tabindex="0"><p>UNIX datagram sockets are a subset of UNIX domain sockets, with the difference being
that while UNIX sockets implement reliable communication of a continuous byte stream
(similarly to TCP), UNIX datagram sockets implement communication of data packets
(similarly to UDP).</p>
<p>The API for UNIX datagram sockets is modeled after the one for UDP sockets, except that
instead of host/port combinations, you use file system paths - here is the UDP &quot;hello&quot;
service example written with UNIX datagram sockets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_unix_datagram_socket</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">create_unix_datagram_socket</span><span class="p">(</span>
        <span class="n">local_path</span><span class="o">=</span><span class="s1">&#39;/tmp/mysock&#39;</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">unix_dg</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">packet</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">unix_dg</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">unix_dg</span><span class="o">.</span><span class="n">sendto</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, &#39;</span> <span class="o">+</span> <span class="n">packet</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>If <code class="docutils literal notranslate"><span class="pre">local_path</span></code> is not set, the UNIX datagram socket will be bound on an</p>
</div>
<p>unnamed address, and will generally not be able to receive datagrams from other UNIX
datagram sockets.</p>
<p>Similarly to UDP sockets, if your case involves sending lots of packets to a single
destination, you can &quot;connect&quot; your UNIX datagram socket to a specific path to avoid
having to pass the path every time you send data to the peer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_connected_unix_datagram_socket</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">create_connected_unix_datagram_socket</span><span class="p">(</span>
        <span class="n">remote_path</span><span class="o">=</span><span class="s1">&#39;/dev/log&#39;</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">unix_dg</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">unix_dg</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hi there!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="threads.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">使用线程</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="typedattrs.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">使用类型化属性</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2018, Alex Grönholm
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/hellowac/anyio-zh-cn" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">使用套接字和流</a><ul>
<li><a class="reference internal" href="#tcp">使用 TCP 套接字</a></li>
<li><a class="reference internal" href="#unix">使用 UNIX 套接字</a><ul>
<li><a class="reference internal" href="#id2">发送和接收文件描述符</a></li>
</ul>
</li>
<li><a class="reference internal" href="#udp">使用 UDP 套接字</a></li>
<li><a class="reference internal" href="#id3">使用 UNIX 数据报套接字</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=b0668c51"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/translations.js?v=beaddf03"></script>
    <script src="_static/tabs.js?v=3030b3cb"></script>
    </body>
</html>