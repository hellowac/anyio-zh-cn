<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="genindex.html" /><link rel="search" title="搜索" href="search.html" /><link rel="next" title="使用类型化属性" href="typedattrs.html" /><link rel="prev" title="使用同步原语" href="synchronization.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>流 - AnyIO 4.6.2 文档</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">AnyIO 4.6.2 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">AnyIO 4.6.2 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basics.html">基础知识</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">创建和管理任务</a></li>
<li class="toctree-l1"><a class="reference internal" href="cancellation.html">取消和超时</a></li>
<li class="toctree-l1"><a class="reference internal" href="synchronization.html">使用同步原语</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">流</a></li>
<li class="toctree-l1"><a class="reference internal" href="typedattrs.html">使用类型化属性</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">使用套接字和流</a></li>
<li class="toctree-l1"><a class="reference internal" href="threads.html">使用线程</a></li>
<li class="toctree-l1"><a class="reference internal" href="subprocesses.html">使用子进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="fileio.html">异步文件 I/O 支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="signals.html">接收操作系统信号</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">使用 AnyIO 进行测试</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API 参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html">从 AnyIO 3 迁移到 AnyIO 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html#anyio-2-anyio-3">从 AnyIO 2 迁移到 AnyIO 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">获取帮助</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html#id2">报告错误</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">为 AnyIO 做出贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="versionhistory.html">版本历史</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/blob/sync-docs/cn_docs/streams.rst?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/edit/sync-docs/cn_docs/streams.rst" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="id1">
<h1>流<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h1>
<p><strong>Streams</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p>在 AnyIO 中, “流(stream)” 是一个简单的接口, 用于将信息从一个地方传输到另一个地方。它可以表示进程间通信或通过网络发送数据。AnyIO 将流分为两类：字节流(byte streams)和对象流(object streams)。</p>
<p>字节流(在 Trio 术语中为“Streams”)是接收和/或发送字节块的对象。它们是基于流套接字的限制来建模的, 这意味着边界不会被严格遵守。实际上, 这意味着例如你调用 <code class="docutils literal notranslate"><span class="pre">.send(b'hello</span> <span class="pre">')</span></code> 然后 <code class="docutils literal notranslate"><span class="pre">.send(b'world')</span></code>, 另一端接收到的数据将被任意拆分, 如( <code class="docutils literal notranslate"><span class="pre">b'hello'</span></code>  和 <code class="docutils literal notranslate"><span class="pre">b'</span> <span class="pre">world'</span></code> )、 <code class="docutils literal notranslate"><span class="pre">b'hello</span> <span class="pre">world'</span></code> 或( <code class="docutils literal notranslate"><span class="pre">b'hel'</span></code>、 <code class="docutils literal notranslate"><span class="pre">b'lo</span> <span class="pre">wo'</span></code>、 <code class="docutils literal notranslate"><span class="pre">b'rld'</span></code>)。</p>
<p>另一方面, 对象流(在 Trio 术语中为“Channels”)处理 Python 对象。这些流最常见的实现是内存对象流。对象流的具体语义因实现方式而异。</p>
<p>许多流实现会包装其他流。其中一些可以包装任何字节导向的流, 即 <code class="docutils literal notranslate"><span class="pre">ObjectStream[bytes]</span></code> 和 <code class="docutils literal notranslate"><span class="pre">ByteStream</span></code>。这使得许多有趣的用例成为可能。</p>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>A &quot;stream&quot; in AnyIO is a simple interface for transporting information from one place to
another. It can mean either in-process communication or sending data over a network.
AnyIO divides streams into two categories: byte streams and object streams.</p>
<p>Byte streams (&quot;Streams&quot; in Trio lingo) are objects that receive and/or send chunks of
bytes. They are modelled after the limitations of the stream sockets, meaning the
boundaries are not respected. In practice this means that if, for example, you call
<code class="docutils literal notranslate"><span class="pre">.send(b'hello</span> <span class="pre">')</span></code> and then <code class="docutils literal notranslate"><span class="pre">.send(b'world')</span></code>, the other end will receive the data
chunked in any arbitrary way, like (<code class="docutils literal notranslate"><span class="pre">b'hello'</span></code> and <code class="docutils literal notranslate"><span class="pre">b'</span> <span class="pre">world'</span></code>), <code class="docutils literal notranslate"><span class="pre">b'hello</span> <span class="pre">world'</span></code>
or (<code class="docutils literal notranslate"><span class="pre">b'hel'</span></code>, <code class="docutils literal notranslate"><span class="pre">b'lo</span> <span class="pre">wo'</span></code>, <code class="docutils literal notranslate"><span class="pre">b'rld'</span></code>).</p>
<p>Object streams (&quot;Channels&quot; in Trio lingo), on the other hand, deal with Python objects.
The most commonly used implementation of these is the memory object stream. The exact
semantics of object streams vary a lot by implementation.</p>
<p>Many stream implementations wrap other streams. Of these, some can wrap any
bytes-oriented streams, meaning <code class="docutils literal notranslate"><span class="pre">ObjectStream[bytes]</span></code> and <code class="docutils literal notranslate"><span class="pre">ByteStream</span></code>. This enables
many interesting use cases.</p>
</div></div>
<section id="memory-object-streams">
<span id="id2"></span><h2>内存对象流<a class="headerlink" href="#memory-object-streams" title="Link to this heading">¶</a></h2>
<p><strong>Memory object streams</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><p>内存对象流用于实现带有多个任务的生产者-消费者模式。通过使用 <a class="reference internal" href="api.html#anyio.create_memory_object_stream" title="anyio.create_memory_object_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_memory_object_stream()</span></code></a>, 你将获得一对对象流：一个用于发送, 一个用于接收。它们本质上像队列, 但支持关闭和异步迭代。</p>
<p>默认情况下, 内存对象流创建时的缓冲区大小为 0。这意味着 <a class="reference internal" href="api.html#anyio.streams.memory.MemoryObjectSendStream.send" title="anyio.streams.memory.MemoryObjectSendStream.send"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a> 将会阻塞, 直到有另一个任务调用 <a class="reference internal" href="api.html#anyio.streams.memory.MemoryObjectReceiveStream.receive" title="anyio.streams.memory.MemoryObjectReceiveStream.receive"><code class="xref py py-meth docutils literal notranslate"><span class="pre">receive()</span></code></a>。你可以在创建流时设置自定义的缓冲区大小。也可以通过传递 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/math.html#math.inf" title="（在 Python v3.13）"><code class="xref py py-data docutils literal notranslate"><span class="pre">math.inf</span></code></a> 作为缓冲区大小来创建一个无限缓冲区, 但这并不推荐使用。</p>
<p>内存对象流可以通过调用 <code class="docutils literal notranslate"><span class="pre">clone()</span></code> 方法进行克隆。每个克隆可以单独关闭, 但只有当所有克隆都关闭时, 流的每一端才会被认为是关闭的。例如, 如果你有两个接收流的克隆, 发送流只有在两个接收流都关闭后才会开始引发 <a class="reference internal" href="api.html#anyio.BrokenResourceError" title="anyio.BrokenResourceError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">BrokenResourceError</span></code></a>。</p>
<p>多个任务可以在同一个内存对象流(或其克隆)上进行发送和接收, 但每个发送的项只会交付给一个接收者。</p>
<p>内存对象流的接收端可以使用异步迭代协议进行迭代。当所有发送流的克隆都关闭时, 循环会退出。</p>
<p>示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">create_memory_object_stream</span><span class="p">,</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">anyio.streams.memory</span> <span class="kn">import</span> <span class="n">MemoryObjectReceiveStream</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">process_items</span><span class="p">(</span><span class="n">receive_stream</span><span class="p">:</span> <span class="n">MemoryObjectReceiveStream</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">receive_stream</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">receive_stream</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;received&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># [str] 指定了通过内存对象流传递的对象类型。这是一个技巧, 因为 create_memory_object_stream</span>
    <span class="c1"># 实际上是一个伪装成函数的类。</span>
    <span class="n">send_stream</span><span class="p">,</span> <span class="n">receive_stream</span> <span class="o">=</span> <span class="n">create_memory_object_stream</span><span class="p">[</span><span class="nb">str</span><span class="p">]()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">process_items</span><span class="p">,</span> <span class="n">receive_stream</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">send_stream</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">send_stream</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;number </span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>与其他 AnyIO 流不同(但与 Trio 的 Channels 一致), 内存对象流可以同步关闭, 使用 <code class="docutils literal notranslate"><span class="pre">close()</span></code> 方法或将流作为上下文管理器来关闭:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio.streams.memory</span> <span class="kn">import</span> <span class="n">MemoryObjectSendStream</span>


<span class="k">def</span> <span class="nf">synchronous_callback</span><span class="p">(</span><span class="n">send_stream</span><span class="p">:</span> <span class="n">MemoryObjectSendStream</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">send_stream</span><span class="p">:</span>
        <span class="n">send_stream</span><span class="o">.</span><span class="n">send_nowait</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><p>Memory object streams are intended for implementing a producer-consumer pattern with
multiple tasks. Using <a class="reference internal" href="api.html#anyio.create_memory_object_stream" title="anyio.create_memory_object_stream"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_memory_object_stream()</span></code></a>, you get a pair of object
streams: one for sending, one for receiving. They essentially work like queues, but with
support for closing and asynchronous iteration.</p>
<p>By default, memory object streams are created with a buffer size of 0. This means that
<a class="reference internal" href="api.html#anyio.streams.memory.MemoryObjectSendStream.send" title="anyio.streams.memory.MemoryObjectSendStream.send"><code class="xref py py-meth docutils literal notranslate"><span class="pre">send()</span></code></a> will block until there's another
task that calls <a class="reference internal" href="api.html#anyio.streams.memory.MemoryObjectReceiveStream.receive" title="anyio.streams.memory.MemoryObjectReceiveStream.receive"><code class="xref py py-meth docutils literal notranslate"><span class="pre">receive()</span></code></a>. You can set
the buffer size to a value of your choosing when creating the stream. It is also
possible to have an unbounded buffer by passing <a class="reference external" href="https://docs.python.org/zh-cn/3/library/math.html#math.inf" title="（在 Python v3.13）"><code class="xref py py-data docutils literal notranslate"><span class="pre">math.inf</span></code></a> as the buffer size but
this is not recommended.</p>
<p>Memory object streams can be cloned by calling the <code class="docutils literal notranslate"><span class="pre">clone()</span></code> method. Each clone can be
closed separately, but each end of the stream is only considered closed once all of its
clones have been closed. For example, if you have two clones of the receive stream, the
send stream will start raising <a class="reference internal" href="api.html#anyio.BrokenResourceError" title="anyio.BrokenResourceError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">BrokenResourceError</span></code></a> only when both receive
streams have been closed.</p>
<p>Multiple tasks can send and receive on the same memory object stream (or its clones) but
each sent item is only ever delivered to a single recipient.</p>
<p>The receive ends of memory object streams can be iterated using the async iteration
protocol. The loop exits when all clones of the send stream have been closed.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">create_memory_object_stream</span><span class="p">,</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">anyio.streams.memory</span> <span class="kn">import</span> <span class="n">MemoryObjectReceiveStream</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">process_items</span><span class="p">(</span><span class="n">receive_stream</span><span class="p">:</span> <span class="n">MemoryObjectReceiveStream</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">receive_stream</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">receive_stream</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;received&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># The [str] specifies the type of the objects being passed through the</span>
    <span class="c1"># memory object stream. This is a bit of trick, as create_memory_object_stream</span>
    <span class="c1"># is actually a class masquerading as a function.</span>
    <span class="n">send_stream</span><span class="p">,</span> <span class="n">receive_stream</span> <span class="o">=</span> <span class="n">create_memory_object_stream</span><span class="p">[</span><span class="nb">str</span><span class="p">]()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">process_items</span><span class="p">,</span> <span class="n">receive_stream</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">send_stream</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">send_stream</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;number </span><span class="si">{</span><span class="n">num</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>In contrast to other AnyIO streams (but in line with Trio's Channels), memory object
streams can be closed synchronously, using either the <code class="docutils literal notranslate"><span class="pre">close()</span></code> method or by using the
stream as a context manager:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio.streams.memory</span> <span class="kn">import</span> <span class="n">MemoryObjectSendStream</span>


<span class="k">def</span> <span class="nf">synchronous_callback</span><span class="p">(</span><span class="n">send_stream</span><span class="p">:</span> <span class="n">MemoryObjectSendStream</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">send_stream</span><span class="p">:</span>
        <span class="n">send_stream</span><span class="o">.</span><span class="n">send_nowait</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id3">
<h2>装订流<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p><strong>Stapled streams</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><p>一个拼接流将任何互相兼容的接收流和发送流结合在一起, 形成一个单一的双向流。</p>
<p>它有两种变体：</p>
<ul class="simple">
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">ByteReceiveStream</span></code> 与 <a class="reference internal" href="api.html#anyio.abc.ByteSendStream" title="anyio.abc.ByteSendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ByteSendStream</span></code></a> 结合)</p></li>
<li><p><code class="xref py py-class docutils literal notranslate"><span class="pre">ObjectReceiveStream</span></code> 与兼容的 <a class="reference internal" href="api.html#anyio.abc.ObjectSendStream" title="anyio.abc.ObjectSendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ObjectSendStream</span></code></a> 结合)</p></li>
</ul>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><p>A stapled stream combines any mutually compatible receive and send stream together,
forming a single bidirectional stream.</p>
<p>It comes in two variants:</p>
<ul class="simple">
<li><p><a class="reference internal" href="api.html#anyio.streams.stapled.StapledByteStream" title="anyio.streams.stapled.StapledByteStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">StapledByteStream</span></code></a> (combines a</p></li>
</ul>
<p><a class="reference internal" href="api.html#anyio.abc.ByteReceiveStream" title="anyio.abc.ByteReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ByteReceiveStream</span></code></a> with a <a class="reference internal" href="api.html#anyio.abc.ByteSendStream" title="anyio.abc.ByteSendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ByteSendStream</span></code></a>)
* <a class="reference internal" href="api.html#anyio.streams.stapled.StapledObjectStream" title="anyio.streams.stapled.StapledObjectStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">StapledObjectStream</span></code></a> (combines an
<a class="reference internal" href="api.html#anyio.abc.ObjectReceiveStream" title="anyio.abc.ObjectReceiveStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ObjectReceiveStream</span></code></a> with a compatible <a class="reference internal" href="api.html#anyio.abc.ObjectSendStream" title="anyio.abc.ObjectSendStream"><code class="xref py py-class docutils literal notranslate"><span class="pre">ObjectSendStream</span></code></a>)</p>
</div></div>
</section>
<section id="id4">
<h2>缓冲字节流<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h2>
<p><strong>Buffered byte streams</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><p>缓冲字节流包装了一个现有的字节导向接收流, 并提供了一些需要缓冲的功能, 例如接收指定数量的字节, 或接收直到找到给定的分隔符为止。</p>
<p>示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">create_memory_object_stream</span>
<span class="kn">from</span> <span class="nn">anyio.streams.buffered</span> <span class="kn">import</span> <span class="n">BufferedByteReceiveStream</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">send</span><span class="p">,</span> <span class="n">receive</span> <span class="o">=</span> <span class="n">create_memory_object_stream</span>
    <span class="n">buffered</span> <span class="o">=</span> <span class="n">BufferedByteReceiveStream</span><span class="p">(</span><span class="n">receive</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="sa">b</span><span class="s1">&#39;hel&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lo, &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;wo&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;rld!&#39;</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">send</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">buffered</span><span class="o">.</span><span class="n">receive_exactly</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">buffered</span><span class="o">.</span><span class="n">receive_until</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>上述脚本会输出以下内容:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sa">b</span><span class="s1">&#39;hello, w&#39;</span>
<span class="sa">b</span><span class="s1">&#39;orld&#39;</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><p>A buffered byte stream wraps an existing bytes-oriented receive stream and provides
certain amenities that require buffering, such as receiving an exact number of bytes, or
receiving until the given delimiter is found.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">create_memory_object_stream</span>
<span class="kn">from</span> <span class="nn">anyio.streams.buffered</span> <span class="kn">import</span> <span class="n">BufferedByteReceiveStream</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">send</span><span class="p">,</span> <span class="n">receive</span> <span class="o">=</span> <span class="n">create_memory_object_stream</span><span class="p">[</span><span class="nb">bytes</span><span class="p">](</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">buffered</span> <span class="o">=</span> <span class="n">BufferedByteReceiveStream</span><span class="p">(</span><span class="n">receive</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="sa">b</span><span class="s1">&#39;hel&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;lo, &#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;wo&#39;</span><span class="p">,</span> <span class="sa">b</span><span class="s1">&#39;rld!&#39;</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">send</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">buffered</span><span class="o">.</span><span class="n">receive_exactly</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">buffered</span><span class="o">.</span><span class="n">receive_until</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;!&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>The above script gives the following output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sa">b</span><span class="s1">&#39;hello, w&#39;</span>
<span class="sa">b</span><span class="s1">&#39;orld&#39;</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id5">
<h2>文本流<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h2>
<p><strong>Text streams</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><p>文本流包装了现有的接收/发送流, 并将字符串编码/解码为字节, 反之亦然。</p>
<p>示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">create_memory_object_stream</span>
<span class="kn">from</span> <span class="nn">anyio.streams.text</span> <span class="kn">import</span> <span class="n">TextReceiveStream</span><span class="p">,</span> <span class="n">TextSendStream</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">bytes_send</span><span class="p">,</span> <span class="n">bytes_receive</span> <span class="o">=</span> <span class="n">create_memory_object_stream</span>
    <span class="n">text_send</span> <span class="o">=</span> <span class="n">TextSendStream</span><span class="p">(</span><span class="n">bytes_send</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">text_send</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;åäö&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bytes_receive</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="n">text_receive</span> <span class="o">=</span> <span class="n">TextReceiveStream</span><span class="p">(</span><span class="n">bytes_receive</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">bytes_send</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">text_receive</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>上述脚本会输出以下内容:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xc3\xa5\xc3\xa4\xc3\xb6</span><span class="s1">&#39;</span>
<span class="s1">&#39;åäö&#39;</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><p>Text streams wrap existing receive/send streams and encode/decode strings to bytes and
vice versa.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">create_memory_object_stream</span>
<span class="kn">from</span> <span class="nn">anyio.streams.text</span> <span class="kn">import</span> <span class="n">TextReceiveStream</span><span class="p">,</span> <span class="n">TextSendStream</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">bytes_send</span><span class="p">,</span> <span class="n">bytes_receive</span> <span class="o">=</span> <span class="n">create_memory_object_stream</span><span class="p">[</span><span class="nb">bytes</span><span class="p">](</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">text_send</span> <span class="o">=</span> <span class="n">TextSendStream</span><span class="p">(</span><span class="n">bytes_send</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">text_send</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;åäö&#39;</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">bytes_receive</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

    <span class="n">text_receive</span> <span class="o">=</span> <span class="n">TextReceiveStream</span><span class="p">(</span><span class="n">bytes_receive</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">bytes_send</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="k">await</span> <span class="n">text_receive</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>The above script gives the following output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="sa">b</span><span class="s1">&#39;</span><span class="se">\xc3\xa5\xc3\xa4\xc3\xb6</span><span class="s1">&#39;</span>
<span class="s1">&#39;åäö&#39;</span>
</pre></div>
</div>
</div></div>
</section>
<section id="filestreams">
<span id="id6"></span><h2>文件流<a class="headerlink" href="#filestreams" title="Link to this heading">¶</a></h2>
<p><strong>File streams</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-5-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-5-5-0" name="5-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-5-5-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-5-5-1" name="5-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-5-5-0" class="sphinx-tabs-panel" id="panel-5-5-0" name="5-0" role="tabpanel" tabindex="0"><p>文件流用于从文件系统中读取或写入文件。它们对于将文件替代为其他数据源, 或将输出写入文件以用于日志记录或调试目的非常有用。</p>
<p>示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">anyio.streams.file</span> <span class="kn">import</span> <span class="n">FileReadStream</span><span class="p">,</span> <span class="n">FileWriteStream</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/tmp/testfile&#39;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">FileWriteStream</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">stream</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, World!&#39;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">FileReadStream</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">()</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-5-5-1" class="sphinx-tabs-panel" hidden="true" id="panel-5-5-1" name="5-1" role="tabpanel" tabindex="0"><p>File streams read from or write to files on the file system. They can be useful for
substituting a file for another source of data, or writing output to a file for logging
or debugging purposes.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">anyio.streams.file</span> <span class="kn">import</span> <span class="n">FileReadStream</span><span class="p">,</span> <span class="n">FileWriteStream</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/tmp/testfile&#39;</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">FileWriteStream</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">stream</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, World!&#39;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">FileReadStream</span><span class="o">.</span><span class="n">from_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">chunk</span><span class="o">.</span><span class="n">decode</span><span class="p">(),</span> <span class="n">end</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">()</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<div class="versionadded">
<p><span class="versionmodified added">Added in version 3.0.</span></p>
</div>
</section>
<section id="tls">
<span id="id7"></span><h2>TLS 流<a class="headerlink" href="#tls" title="Link to this heading">¶</a></h2>
<p><strong>TLS streams</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-6-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-6-6-0" name="6-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-6-6-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-6-6-1" name="6-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-6-6-0" class="sphinx-tabs-panel" id="panel-6-6-0" name="6-0" role="tabpanel" tabindex="0"><p>TLS(传输层安全性), 是SSL(安全套接字层)的继任者, 是在AnyIO中为TCP流提供身份验证和保密性的支持方式。</p>
<p>TLS通常在连接建立后立即进行。握手过程包括以下步骤：</p>
<ul class="simple">
<li><p>将证书发送给对端(通常仅由服务器进行)</p></li>
<li><p>将对端的证书与受信任的CA证书进行验证</p></li>
<li><p>检查对端主机名是否与证书匹配</p></li>
</ul>
</div><div aria-labelledby="tab-6-6-1" class="sphinx-tabs-panel" hidden="true" id="panel-6-6-1" name="6-1" role="tabpanel" tabindex="0"><p>TLS (Transport Layer Security), the successor to SSL (Secure Sockets Layer), is the
supported way of providing authenticity and confidentiality for TCP streams in AnyIO.</p>
<p>TLS is typically established right after the connection has been made. The handshake
involves the following steps:</p>
<ul class="simple">
<li><p>Sending the certificate to the peer (usually just by the server)</p></li>
<li><p>Checking the peer certificate(s) against trusted CA certificates</p></li>
<li><p>Checking that the peer host name matches the certificate</p></li>
</ul>
</div></div>
<section id="id8">
<h3>获取服务器证书<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h3>
<p><strong>Obtaining a server certificate</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-7-7-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-7-7-0" name="7-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-7-7-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-7-7-1" name="7-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-7-7-0" class="sphinx-tabs-panel" id="panel-7-7-0" name="7-0" role="tabpanel" tabindex="0"><p>获取X.509证书用于服务器的主要方式有三种：</p>
<ol class="arabic simple">
<li><p>创建一个自签名证书</p></li>
<li><p>使用 <a class="reference external" href="https://certbot.eff.org/">certbot</a> 或类似软件从 <a class="reference external" href="https://letsencrypt.org/">Let's Encrypt</a> 自动获取证书</p></li>
<li><p>从证书供应商处购买一个证书</p></li>
</ol>
<p>第一种选项可能是最简单的, 但这要求任何连接到您的服务器的客户端将自签名证书添加到其受信任证书列表中。显然, 这在本地开发之外是不可行的, 并且在生产环境中强烈不推荐使用。</p>
<p>第二种选项如今是推荐的方法, 只要您有一个可以运行certbot_或类似软件的环境, 并且能够在必要时自动替换证书为更新版本, 同时不需要额外的功能, 比如类2验证。</p>
<p>第三种选项可能是您唯一有效的选择, 特别是在您对证书有特殊要求, 只有证书供应商可以满足这些要求, 或者在您的环境中自动更新证书不可行或不切实际时。</p>
</div><div aria-labelledby="tab-7-7-1" class="sphinx-tabs-panel" hidden="true" id="panel-7-7-1" name="7-1" role="tabpanel" tabindex="0"><p>There are three principal ways you can get an X.509 certificate for your server:</p>
<ol class="arabic simple">
<li><p>Create a self signed certificate</p></li>
<li><p>Use <a class="reference external" href="https://certbot.eff.org/">certbot</a> or a similar software to automatically obtain certificates from <a class="reference external" href="https://letsencrypt.org/">Let's Encrypt</a></p></li>
<li><p>Buy one from a certificate vendor</p></li>
</ol>
<p>The first option is probably the easiest, but this requires that any client
connecting to your server adds the self signed certificate to their list of trusted
certificates. This is of course impractical outside of local development and is strongly
discouraged in production use.</p>
<p>The second option is nowadays the recommended method, as long as you have an environment
where running <a class="reference external" href="https://certbot.eff.org/">certbot</a> or similar software can automatically replace the certificate
with a newer one when necessary, and that you don't need any extra features like class 2
validation.</p>
<p>The third option may be your only valid choice when you have special requirements for
the certificate that only a certificate vendor can fulfill, or that automatically
renewing the certificates is not possible or practical in your environment.</p>
</div></div>
</section>
<section id="id9">
<h3>使用自签名证书<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h3>
<p><strong>Using self signed certificates</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-8-8-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-8-8-0" name="8-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-8-8-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-8-8-1" name="8-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-8-8-0" class="sphinx-tabs-panel" id="panel-8-8-0" name="8-0" role="tabpanel" tabindex="0"><p>要为 <code class="docutils literal notranslate"><span class="pre">localhost</span></code> 创建一个自签名证书, 可以使用openssl_命令行工具：</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>openssl<span class="w"> </span>req<span class="w"> </span>-x509<span class="w"> </span>-newkey<span class="w"> </span>rsa:2048<span class="w"> </span>-subj<span class="w"> </span><span class="s1">&#39;/CN=localhost&#39;</span><span class="w"> </span>-keyout<span class="w"> </span>key.pem<span class="w"> </span>-out<span class="w"> </span>cert.pem<span class="w"> </span>-nodes<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span>
</pre></div>
</div>
<p>这将创建一个(2048位)私有RSA密钥(<code class="docutils literal notranslate"><span class="pre">key.pem</span></code>)和一个证书(<code class="docutils literal notranslate"><span class="pre">cert.pem</span></code>), 其主机名为“localhost”。在这些设置下, 证书的有效期为一年。</p>
<p>要使用这个密钥-证书对设置服务器, 可以参考以下示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ssl</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_tcp_listener</span><span class="p">,</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">anyio.streams.tls</span> <span class="kn">import</span> <span class="n">TLSListener</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 创建一个用于客户端身份验证的上下文</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="p">)</span>

    <span class="c1"># 加载服务器证书和私钥</span>
    <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">certfile</span><span class="o">=</span><span class="s1">&#39;cert.pem&#39;</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="s1">&#39;key.pem&#39;</span><span class="p">)</span>

    <span class="c1"># 创建监听器并开始提供连接服务</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="n">TLSListener</span><span class="p">(</span><span class="k">await</span> <span class="n">create_tcp_listener</span><span class="p">(</span><span class="n">local_port</span><span class="o">=</span><span class="mi">1234</span><span class="p">),</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">listener</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>然后, 可以使用以下方式连接到此服务器:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ssl</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">connect_tcp</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># 如果证书没有被您计算机上安装的CA证书信任, 则需要以下两个步骤；</span>
    <span class="c1"># 如果您使用Let&#39;s Encrypt或商业证书供应商, 则可以跳过这部分</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cafile</span><span class="o">=</span><span class="s1">&#39;cert.pem&#39;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">connect_tcp</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">1234</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Client</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-8-8-1" class="sphinx-tabs-panel" hidden="true" id="panel-8-8-1" name="8-1" role="tabpanel" tabindex="0"><p>To create a self signed certificate for <code class="docutils literal notranslate"><span class="pre">localhost</span></code>, you can use the <a class="reference external" href="https://www.openssl.org/">openssl</a> command
line tool:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>openssl<span class="w"> </span>req<span class="w"> </span>-x509<span class="w"> </span>-newkey<span class="w"> </span>rsa:2048<span class="w"> </span>-subj<span class="w"> </span><span class="s1">&#39;/CN=localhost&#39;</span><span class="w"> </span>-keyout<span class="w"> </span>key.pem<span class="w"> </span>-out<span class="w"> </span>cert.pem<span class="w"> </span>-nodes<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span>
</pre></div>
</div>
<p>This creates a (2048 bit) private RSA key (<code class="docutils literal notranslate"><span class="pre">key.pem</span></code>) and a certificate (<code class="docutils literal notranslate"><span class="pre">cert.pem</span></code>)
matching the host name &quot;localhost&quot;. The certificate will be valid for one year with
these settings.</p>
<p>To set up a server using this key-certificate pair:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ssl</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_tcp_listener</span><span class="p">,</span> <span class="n">run</span>
<span class="kn">from</span> <span class="nn">anyio.streams.tls</span> <span class="kn">import</span> <span class="n">TLSListener</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">client</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Hello, </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># Create a context for the purpose of authenticating clients</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="p">)</span>

    <span class="c1"># Load the server certificate and private key</span>
    <span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">certfile</span><span class="o">=</span><span class="s1">&#39;cert.pem&#39;</span><span class="p">,</span> <span class="n">keyfile</span><span class="o">=</span><span class="s1">&#39;key.pem&#39;</span><span class="p">)</span>

    <span class="c1"># Create the listener and start serving connections</span>
    <span class="n">listener</span> <span class="o">=</span> <span class="n">TLSListener</span><span class="p">(</span><span class="k">await</span> <span class="n">create_tcp_listener</span><span class="p">(</span><span class="n">local_port</span><span class="o">=</span><span class="mi">1234</span><span class="p">),</span> <span class="n">context</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">listener</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">handle</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>Connecting to this server can then be done as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ssl</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">connect_tcp</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="c1"># These two steps are only required for certificates that are not trusted by the</span>
    <span class="c1"># installed CA certificates on your machine, so you can skip this part if you</span>
    <span class="c1"># use Let&#39;s Encrypt or a commercial certificate vendor</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="p">)</span>
    <span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cafile</span><span class="o">=</span><span class="s1">&#39;cert.pem&#39;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">connect_tcp</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">1234</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="n">context</span><span class="p">)</span> <span class="k">as</span> <span class="n">client</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Client</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">receive</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id10">
<h3>动态创建自签名证书<a class="headerlink" href="#id10" title="Link to this heading">¶</a></h3>
<p><strong>Creating self-signed certificates on the fly</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-9-9-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-9-9-0" name="9-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-9-9-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-9-9-1" name="9-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-9-9-0" class="sphinx-tabs-panel" id="panel-9-9-0" name="9-0" role="tabpanel" tabindex="0"><p>在测试启用了TLS的服务时, 动态生成证书会更加方便。为此, 您可以使用 <a class="reference external" href="https://pypi.org/project/trustme/">trustme</a> 库:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ssl</span>

<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">trustme</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ca</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">trustme</span><span class="o">.</span><span class="n">CA</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">server_context</span><span class="p">(</span><span class="n">ca</span><span class="p">):</span>
    <span class="n">server_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="p">)</span>
    <span class="n">ca</span><span class="o">.</span><span class="n">issue_cert</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">configure_cert</span><span class="p">(</span><span class="n">server_context</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">server_context</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">client_context</span><span class="p">(</span><span class="n">ca</span><span class="p">):</span>
    <span class="n">client_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="p">)</span>
    <span class="n">ca</span><span class="o">.</span><span class="n">configure_trust</span><span class="p">(</span><span class="n">client_context</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">client_context</span>
</pre></div>
</div>
<p>然后, 您可以将上述fixture中的服务器和客户端上下文传递给 <a class="reference internal" href="api.html#anyio.streams.tls.TLSListener" title="anyio.streams.tls.TLSListener"><code class="xref py py-class docutils literal notranslate"><span class="pre">TLSListener</span></code></a>、<a class="reference internal" href="api.html#anyio.streams.tls.TLSStream.wrap" title="anyio.streams.tls.TLSStream.wrap"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wrap()</span></code></a> 或您在任一端使用的任何方法。</p>
</div><div aria-labelledby="tab-9-9-1" class="sphinx-tabs-panel" hidden="true" id="panel-9-9-1" name="9-1" role="tabpanel" tabindex="0"><p>When testing your TLS enabled service, it would be convenient to generate the
certificates on the fly. To this end, you can use the <a class="reference external" href="https://pypi.org/project/trustme/">trustme</a> library:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">ssl</span>

<span class="kn">import</span> <span class="nn">pytest</span>
<span class="kn">import</span> <span class="nn">trustme</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ca</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">trustme</span><span class="o">.</span><span class="n">CA</span><span class="p">()</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">server_context</span><span class="p">(</span><span class="n">ca</span><span class="p">):</span>
    <span class="n">server_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="p">)</span>
    <span class="n">ca</span><span class="o">.</span><span class="n">issue_cert</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">configure_cert</span><span class="p">(</span><span class="n">server_context</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">server_context</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="s1">&#39;session&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">client_context</span><span class="p">(</span><span class="n">ca</span><span class="p">):</span>
    <span class="n">client_context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="p">)</span>
    <span class="n">ca</span><span class="o">.</span><span class="n">configure_trust</span><span class="p">(</span><span class="n">client_context</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">client_context</span>
</pre></div>
</div>
<p>You can then pass the server and client contexts from the above fixtures to
<a class="reference internal" href="api.html#anyio.streams.tls.TLSListener" title="anyio.streams.tls.TLSListener"><code class="xref py py-class docutils literal notranslate"><span class="pre">TLSListener</span></code></a>, <a class="reference internal" href="api.html#anyio.streams.tls.TLSStream.wrap" title="anyio.streams.tls.TLSStream.wrap"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wrap()</span></code></a> or whatever you
use on either side.</p>
</div></div>
</section>
<section id="eof">
<h3>处理不规则的 EOF<a class="headerlink" href="#eof" title="Link to this heading">¶</a></h3>
<p><strong>Dealing with ragged EOFs</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-10-10-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-10-10-0" name="10-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-10-10-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-10-10-1" name="10-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-10-10-0" class="sphinx-tabs-panel" id="panel-10-10-0" name="10-0" role="tabpanel" tabindex="0"><p>根据 <a class="reference external" href="TLSstandard">TLS标准</a> , 加密连接应该以关闭握手结束。此做法可以防止所谓的 <a class="reference external" href="truncationattacks">截断攻击</a> 。然而, 广泛使用的协议实现(如HTTP)通常忽略这一要求, 因为协议级别的关闭信号会使关闭握手变得多余。</p>
<p>AnyIO 默认遵循此标准(不同于Python标准库的 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/ssl.html#module-ssl" title="（在 Python v3.13）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">ssl</span></code></a> 模块)。这一实践的实际含义是, 如果您正在实现一个预期跳过TLS关闭握手的协议, 您需要在 <a class="reference internal" href="api.html#anyio.streams.tls.TLSStream.wrap" title="anyio.streams.tls.TLSStream.wrap"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wrap()</span></code></a> 或 <a class="reference internal" href="api.html#anyio.streams.tls.TLSListener" title="anyio.streams.tls.TLSListener"><code class="xref py py-class docutils literal notranslate"><span class="pre">TLSListener</span></code></a> 中传递 <code class="docutils literal notranslate"><span class="pre">standard_compatible=False</span></code> 选项。</p>
</div><div aria-labelledby="tab-10-10-1" class="sphinx-tabs-panel" hidden="true" id="panel-10-10-1" name="10-1" role="tabpanel" tabindex="0"><p>According to the <a class="reference external" href="https://tools.ietf.org/html/draft-ietf-tls-tls13-28">TLS standard</a>, encrypted connections should end with a closing
handshake. This practice prevents so-called <a class="reference external" href="https://en.wikipedia.org/wiki/Transport_Layer_Security#Attacks_against_TLS/SSL">truncation attacks</a>. However, broadly
available implementations for protocols such as HTTP, widely ignore this requirement
because the protocol level closing signal would make the shutdown handshake redundant.</p>
<p>AnyIO follows the standard by default (unlike the Python standard library's <a class="reference external" href="https://docs.python.org/zh-cn/3/library/ssl.html#module-ssl" title="（在 Python v3.13）"><code class="xref py py-mod docutils literal notranslate"><span class="pre">ssl</span></code></a>
module). The practical implication of this is that if you're implementing a protocol
that is expected to skip the TLS closing handshake, you need to pass the
<code class="docutils literal notranslate"><span class="pre">standard_compatible=False</span></code> option to <a class="reference internal" href="api.html#anyio.streams.tls.TLSStream.wrap" title="anyio.streams.tls.TLSStream.wrap"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wrap()</span></code></a> or
<a class="reference internal" href="api.html#anyio.streams.tls.TLSListener" title="anyio.streams.tls.TLSListener"><code class="xref py py-class docutils literal notranslate"><span class="pre">TLSListener</span></code></a>.</p>
</div></div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="typedattrs.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">使用类型化属性</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="synchronization.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">使用同步原语</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2018, Alex Grönholm
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/hellowac/anyio-zh-cn" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">流</a><ul>
<li><a class="reference internal" href="#memory-object-streams">内存对象流</a></li>
<li><a class="reference internal" href="#id3">装订流</a></li>
<li><a class="reference internal" href="#id4">缓冲字节流</a></li>
<li><a class="reference internal" href="#id5">文本流</a></li>
<li><a class="reference internal" href="#filestreams">文件流</a></li>
<li><a class="reference internal" href="#tls">TLS 流</a><ul>
<li><a class="reference internal" href="#id8">获取服务器证书</a></li>
<li><a class="reference internal" href="#id9">使用自签名证书</a></li>
<li><a class="reference internal" href="#id10">动态创建自签名证书</a></li>
<li><a class="reference internal" href="#eof">处理不规则的 EOF</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=b0668c51"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/translations.js?v=beaddf03"></script>
    <script src="_static/tabs.js?v=3030b3cb"></script>
    </body>
</html>