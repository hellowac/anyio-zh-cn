<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="genindex.html" /><link rel="search" title="搜索" href="search.html" /><link rel="next" title="使用同步原语" href="synchronization.html" /><link rel="prev" title="创建和管理任务" href="tasks.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>取消和超时 - AnyIO 4.6.2 文档</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">AnyIO 4.6.2 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">AnyIO 4.6.2 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basics.html">基础知识</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">创建和管理任务</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">取消和超时</a></li>
<li class="toctree-l1"><a class="reference internal" href="synchronization.html">使用同步原语</a></li>
<li class="toctree-l1"><a class="reference internal" href="streams.html">流</a></li>
<li class="toctree-l1"><a class="reference internal" href="typedattrs.html">使用类型化属性</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">使用套接字和流</a></li>
<li class="toctree-l1"><a class="reference internal" href="threads.html">使用线程</a></li>
<li class="toctree-l1"><a class="reference internal" href="subprocesses.html">使用子进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="fileio.html">异步文件 I/O 支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="signals.html">接收操作系统信号</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">使用 AnyIO 进行测试</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API 参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html">从 AnyIO 3 迁移到 AnyIO 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html#anyio-2-anyio-3">从 AnyIO 2 迁移到 AnyIO 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">获取帮助</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html#id2">报告错误</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">为 AnyIO 做出贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="versionhistory.html">版本历史</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/blob/sync-docs/cn_docs/cancellation.rst?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/edit/sync-docs/cn_docs/cancellation.rst" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="id1">
<h1>取消和超时<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h1>
<p>Cancellation and timeouts</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p>取消任务的能力是异步编程模型的主要优势。而线程则无法被强制终止，关闭它们需要线程内代码的完全配合。</p>
<p>在 AnyIO 中，任务的取消遵循 <a class="reference external" href="https://trio.readthedocs.io/en/latest/reference-core.html#cancellation-and-timeouts">Trio</a> 框架建立的模型。这意味着任务的取消是通过所谓的 <em>取消作用域</em> 实现的。取消作用域被用作上下文管理器，并且可以嵌套。取消一个取消作用域会取消其内部所有嵌套的取消作用域。如果任务正在等待某个操作，则会立即被取消。如果任务刚刚开始运行，它将继续运行，直到第一次尝试执行需要等待的操作（如 <a class="reference internal" href="api.html#anyio.sleep" title="anyio.sleep"><code class="xref py py-func docutils literal notranslate"><span class="pre">sleep()</span></code></a> ）时才会被取消。</p>
<p>任务组包含其自己的取消作用域。通过取消该作用域可以取消整个任务组。</p>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>The ability to cancel tasks is the foremost advantage of the asynchronous programming
model. Threads, on the other hand, cannot be forcibly killed and shutting them down will
require perfect cooperation from the code running in them.</p>
<p>Cancellation in AnyIO follows the model established by the <a class="reference external" href="https://trio.readthedocs.io/en/latest/reference-core.html#cancellation-and-timeouts">Trio</a> framework. This means
that cancellation of tasks is done via so called <em>cancel scopes</em>. Cancel scopes are used
as context managers and can be nested. Cancelling a cancel scope cancels all cancel
scopes nested within it. If a task is waiting on something, it is cancelled immediately.
If the task is just starting, it will run until it first tries to run an operation
requiring waiting, such as <a class="reference internal" href="api.html#anyio.sleep" title="anyio.sleep"><code class="xref py py-func docutils literal notranslate"><span class="pre">sleep()</span></code></a>.</p>
<p>A task group contains its own cancel scope. The entire task group can be cancelled by
cancelling this scope.</p>
</div></div>
<section id="id2">
<h2>超时<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p><strong>Timeouts</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><p>网络操作通常可能需要很长时间，因此你通常希望设置某种超时机制，以确保你的应用不会永远卡住。主要有两种方法来实现这一点：<a class="reference internal" href="api.html#anyio.move_on_after" title="anyio.move_on_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">move_on_after()</span></code></a> 和 <a class="reference internal" href="api.html#anyio.fail_after" title="anyio.fail_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">fail_after()</span></code></a>。这两者都作为同步上下文管理器使用。它们之间的区别在于，前者在超时后简单地提前退出上下文块，而后者则会引发 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#TimeoutError" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">TimeoutError</span></code></a>。</p>
<p>这两种方法都会创建一个新的取消作用域，你可以通过访问 <a class="reference internal" href="api.html#anyio.CancelScope.deadline" title="anyio.CancelScope.deadline"><code class="xref py py-attr docutils literal notranslate"><span class="pre">deadline</span></code></a> 属性来检查截止时间。然而，请注意，外部取消作用域的截止时间可能早于当前取消作用域的截止时间。要检查实际的截止时间，你可以使用 <a class="reference internal" href="api.html#anyio.current_effective_deadline" title="anyio.current_effective_deadline"><code class="xref py py-func docutils literal notranslate"><span class="pre">current_effective_deadline()</span></code></a> 函数。</p>
<p>下面是你通常如何使用超时的示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">move_on_after</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">move_on_after</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting sleep&#39;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This should never be printed&#39;</span><span class="p">)</span>

        <span class="c1"># 如果超时达到，cancelled_caught 属性将为 True</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exited cancel scope, cancelled =&#39;</span><span class="p">,</span> <span class="n">scope</span><span class="o">.</span><span class="n">cancelled_caught</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>不建议直接从 <a class="reference internal" href="api.html#anyio.fail_after" title="anyio.fail_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">fail_after()</span></code></a> 取消作用域，因为如果退出作用域的延迟足够长，导致超过截止时间，这可能会错误地引发 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#TimeoutError" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">TimeoutError</span></code></a>。</p>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><p>Networked operations can often take a long time, and you usually want to set up some
kind of a timeout to ensure that your application doesn't stall forever. There are two
principal ways to do this: <a class="reference internal" href="api.html#anyio.move_on_after" title="anyio.move_on_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">move_on_after()</span></code></a> and <a class="reference internal" href="api.html#anyio.fail_after" title="anyio.fail_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">fail_after()</span></code></a>. Both are used
as synchronous context managers. The difference between these two is that the former
simply exits the context block prematurely on a timeout, while the other raises a
<a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#TimeoutError" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">TimeoutError</span></code></a>.</p>
<p>Both methods create a new cancel scope, and you can check the deadline by accessing the
<a class="reference internal" href="api.html#anyio.CancelScope.deadline" title="anyio.CancelScope.deadline"><code class="xref py py-attr docutils literal notranslate"><span class="pre">deadline</span></code></a> attribute. Note, however, that an outer cancel scope
may have an earlier deadline than your current cancel scope. To check the actual
deadline, you can use the <a class="reference internal" href="api.html#anyio.current_effective_deadline" title="anyio.current_effective_deadline"><code class="xref py py-func docutils literal notranslate"><span class="pre">current_effective_deadline()</span></code></a> function.</p>
<p>Here's how you typically use timeouts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">move_on_after</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">move_on_after</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Starting sleep&#39;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This should never be printed&#39;</span><span class="p">)</span>

        <span class="c1"># The cancelled_caught property will be True if timeout was reached</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Exited cancel scope, cancelled =&#39;</span><span class="p">,</span> <span class="n">scope</span><span class="o">.</span><span class="n">cancelled_caught</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>It's recommended not to directly cancel a scope from <a class="reference internal" href="api.html#anyio.fail_after" title="anyio.fail_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">fail_after()</span></code></a>, as
that may currently result in <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#TimeoutError" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">TimeoutError</span></code></a> being erroneously raised if exiting
the scope is delayed long enough for the deadline to be exceeded.</p>
</div>
</div></div>
</section>
<section id="id3">
<h2>屏蔽<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p><strong>Shielding</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><p>在某些情况下，你可能希望暂时保护任务免于被取消。最重要的应用场景是对异步资源执行关闭操作。</p>
<p>为此，可以使用 <code class="docutils literal notranslate"><span class="pre">shield=True</span></code> 参数打开一个新的取消作用域:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">CancelScope</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">external_task</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Started sleeping in the external task&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This line should never be seen&#39;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">CancelScope</span><span class="p">(</span><span class="n">shield</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">external_task</span><span class="p">)</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">cancel_scope</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Started sleeping in the host task&#39;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished sleeping in the host task&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>被保护的代码块将免于取消，除非该保护代码块本身正在被取消。保护取消作用域通常最好与 <a class="reference internal" href="api.html#anyio.move_on_after" title="anyio.move_on_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">move_on_after()</span></code></a> 或 <a class="reference internal" href="api.html#anyio.fail_after" title="anyio.fail_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">fail_after()</span></code></a> 结合使用，这两者也接受 <code class="docutils literal notranslate"><span class="pre">shield=True</span></code> 参数。</p>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><p>There are cases where you want to shield your task from cancellation, at least
temporarily. The most important such use case is performing shutdown procedures on
asynchronous resources.</p>
<p>To accomplish this, open a new cancel scope with the <code class="docutils literal notranslate"><span class="pre">shield=True</span></code> argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">CancelScope</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">external_task</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Started sleeping in the external task&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;This line should never be seen&#39;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">CancelScope</span><span class="p">(</span><span class="n">shield</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">external_task</span><span class="p">)</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">cancel_scope</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Started sleeping in the host task&#39;</span><span class="p">)</span>
            <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Finished sleeping in the host task&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>The shielded block will be exempt from cancellation except when the shielded block
itself is being cancelled. Shielding a cancel scope is often best combined with
<a class="reference internal" href="api.html#anyio.move_on_after" title="anyio.move_on_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">move_on_after()</span></code></a> or <a class="reference internal" href="api.html#anyio.fail_after" title="anyio.fail_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">fail_after()</span></code></a>, both of which also accept
<code class="docutils literal notranslate"><span class="pre">shield=True</span></code>.</p>
</div></div>
</section>
<section id="id4">
<h2>完成<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h2>
<p><strong>Finalization</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><p>有时你可能希望在操作失败时执行清理操作:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">do_something</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">run_async_stuff</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="c1"># (执行清理操作)</span>
        <span class="k">raise</span>
</pre></div>
</div>
<p>在某些特定情况下，你可能只想捕获取消异常。这比较棘手，因为每个异步框架都有自己的异常类，而 AnyIO 无法控制任务在取消时抛出的异常。为了解决这个问题，AnyIO 提供了一种方法来获取当前运行的异步框架特定的异常类，使用 <a class="reference internal" href="api.html#anyio.get_cancelled_exc_class" title="anyio.get_cancelled_exc_class"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_cancelled_exc_class()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">get_cancelled_exc_class</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">do_something</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">run_async_stuff</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">get_cancelled_exc_class</span><span class="p">():</span>
        <span class="c1"># (执行清理操作)</span>
        <span class="k">raise</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>如果捕获了取消异常，务必重新抛出它。未能重新抛出可能会导致应用程序出现未定义的行为。</p>
</div>
<p>如果在清理过程中需要使用 <code class="docutils literal notranslate"><span class="pre">await</span></code>，你需要将其包含在一个受保护的取消作用域中，否则操作会立即被取消，因为它已经处于一个被取消的作用域中:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">do_something</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">run_async_stuff</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">get_cancelled_exc_class</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">CancelScope</span><span class="p">(</span><span class="n">shield</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">some_cleanup_function</span><span class="p">()</span>

        <span class="k">raise</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><p>Sometimes you may want to perform cleanup operations in response to the failure of the
operation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">do_something</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">run_async_stuff</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">BaseException</span><span class="p">:</span>
        <span class="c1"># (perform cleanup)</span>
        <span class="k">raise</span>
</pre></div>
</div>
<p>In some specific cases, you might only want to catch the cancellation exception. This is
tricky because each async framework has its own exception class for that and AnyIO
cannot control which exception is raised in the task when it's cancelled. To work around
that, AnyIO provides a way to retrieve the exception class specific to the currently
running async framework, using:func:<cite>~get_cancelled_exc_class</cite>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">get_cancelled_exc_class</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">do_something</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">run_async_stuff</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">get_cancelled_exc_class</span><span class="p">():</span>
        <span class="c1"># (perform cleanup)</span>
        <span class="k">raise</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>Always reraise the cancellation exception if you catch it. Failing to do so
may cause undefined behavior in your application.</p>
</div>
<p>If you need to use <code class="docutils literal notranslate"><span class="pre">await</span></code> during finalization, you need to enclose it in a shielded
cancel scope, or the operation will be cancelled immediately since it's in an already
cancelled scope:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">do_something</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">run_async_stuff</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">get_cancelled_exc_class</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">CancelScope</span><span class="p">(</span><span class="n">shield</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">await</span> <span class="n">some_cleanup_function</span><span class="p">()</span>

        <span class="k">raise</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id5">
<h2>避免取消范围堆栈损坏<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h2>
<p><strong>Avoiding cancel scope stack corruption</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><p>在使用取消作用域时，重要的是它们在每个任务内应按照 LIFO（后进先出）顺序被进入和退出。通常这不是问题，因为取消作用域通常作为上下文管理器使用。然而，在某些情况下，取消作用域堆栈可能仍然会发生损坏：</p>
<ul class="simple">
<li><p>手动调用 <code class="docutils literal notranslate"><span class="pre">CancelScope.__enter__()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">CancelScope.__exit__()</span></code>，通常是在另一个上下文管理器类中，以错误的顺序调用</p></li>
<li><p>使用 <code class="docutils literal notranslate"><span class="pre">[Async]ExitStack</span></code> 的取消作用域，方式是通过嵌套上下文管理器无法实现的方式</p></li>
<li><p>使用低级协程协议在不同的取消作用域中执行协程函数的部分内容</p></li>
<li><p>在异步生成器中使用 <code class="docutils literal notranslate"><span class="pre">yield</span></code>，同时该生成器被包裹在取消作用域中</p></li>
</ul>
<p>记住，任务组包含它们自己的取消作用域，因此相同的风险情况也适用于它们。</p>
<p>例如，以下代码是非常可疑的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 错误！</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">some_generator</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
        <span class="k">yield</span>
</pre></div>
</div>
<p>这段代码的问题在于它违反了结构性并发：如果生成的任务引发异常会发生什么？宿主任务将因此被取消，但在这种情况下，宿主任务可能早已结束。即使没有结束，生成器中的任何封闭 <code class="docutils literal notranslate"><span class="pre">try...except</span></code> 也不会被触发。不幸的是，AnyIO 目前无法自动检测这种情况，因此实际上你可能会因为运行类似代码而在应用程序中遇到一些奇怪的行为。</p>
<p>然而，根据它们的使用方式，这种模式 <em>通常</em> 是安全的，只要你确保同一个宿主任务在整个封闭代码块中一直在运行:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 在大多数情况下是安全的！</span>
<span class="nd">@async_context_manager</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">some_context_manager</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
        <span class="k">yield</span>
</pre></div>
</div>
<p>在 AnyIO 3.6 之前，这种用法模式在 pytest 的异步生成器固定装置中也是无效的。然而，从 3.6 开始，每个异步生成器固定装置都会在同一个任务中从头到尾运行，这使得任务组或取消作用域可以安全地跨越 <code class="docutils literal notranslate"><span class="pre">yield</span></code>。</p>
<p>当你手动实现异步上下文管理器协议，并且你的异步上下文管理器需要使用其他上下文管理器时，你可能会发现有必要直接调用它们的 <code class="docutils literal notranslate"><span class="pre">__aenter__()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">__aexit__()</span></code>。在这种情况下，确保它们的 <code class="docutils literal notranslate"><span class="pre">__aexit__()</span></code> 方法按 <code class="docutils literal notranslate"><span class="pre">__aenter__()</span></code> 调用的逆序被调用是至关重要的。为此，你可能会发现 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/contextlib.html#contextlib.AsyncExitStack" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncExitStack</span></code></a> 类非常有用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">AsyncExitStack</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_task_group</span>


<span class="k">class</span> <span class="nc">MyAsyncContextManager</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exitstack</span> <span class="o">=</span> <span class="n">AsyncExitStack</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitstack</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_group</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitstack</span><span class="o">.</span><span class="n">enter_async_context</span><span class="p">(</span>
            <span class="n">create_task_group</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitstack</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><p>When using cancel scopes, it is important that they are entered and exited in LIFO (last
in, first out) order within each task. This is usually not an issue since cancel scopes
are normally used as context managers. However, in certain situations, cancel scope
stack corruption might still occur:</p>
<ul class="simple">
<li><p>Manually calling <code class="docutils literal notranslate"><span class="pre">CancelScope.__enter__()</span></code> and <code class="docutils literal notranslate"><span class="pre">CancelScope.__exit__()</span></code>, usually</p></li>
</ul>
<p>from another context manager class, in the wrong order
* Using cancel scopes with <code class="docutils literal notranslate"><span class="pre">[Async]ExitStack</span></code> in a manner that couldn't be achieved by
nesting them as context managers
* Using the low level coroutine protocol to execute parts of the coroutine function in
different cancel scopes
* Yielding in an async generator while enclosed in a cancel scope</p>
<p>Remember that task groups contain their own cancel scopes so the same list of risky
situations applies to them too.</p>
<p>As an example, the following code is highly dubious:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bad!</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">some_generator</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
        <span class="k">yield</span>
</pre></div>
</div>
<p>The problem with this code is that it violates structural concurrency: what happens if
the spawned task raises an exception? The host task would be cancelled as a result, but
the host task might be long gone by the time that happens. Even if it weren't, any
enclosing <code class="docutils literal notranslate"><span class="pre">try...except</span></code> in the generator would not be triggered. Unfortunately there
is currently no way to automatically detect this condition in AnyIO, so in practice you
may simply experience some weird behavior in your application as a consequence of
running code like above.</p>
<p>Depending on how they are used, this pattern is, however, <em>usually</em> safe to use in
asynchronous context managers, so long as you make sure that the same host task keeps
running throughout the entire enclosed code block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Okay in most cases!</span>
<span class="nd">@async_context_manager</span>
<span class="k">async</span> <span class="k">def</span> <span class="nf">some_context_manager</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">foo</span><span class="p">)</span>
        <span class="k">yield</span>
</pre></div>
</div>
<p>Prior to AnyIO 3.6, this usage pattern was also invalid in pytest's asynchronous
generator fixtures. Starting from 3.6, however, each async generator fixture is run from
start to end in the same task, making it possible to have task groups or cancel scopes
safely straddle the <code class="docutils literal notranslate"><span class="pre">yield</span></code>.</p>
<p>When you're implementing the async context manager protocol manually and your async
context manager needs to use other context managers, you may find it necessary to call
their <code class="docutils literal notranslate"><span class="pre">__aenter__()</span></code> and <code class="docutils literal notranslate"><span class="pre">__aexit__()</span></code> directly. In such cases, it is absolutely
vital to ensure that their <code class="docutils literal notranslate"><span class="pre">__aexit__()</span></code> methods are called in the exact reverse order
of the <code class="docutils literal notranslate"><span class="pre">__aenter__()</span></code> calls. To this end, you may find the
<a class="reference external" href="https://docs.python.org/zh-cn/3/library/contextlib.html#contextlib.AsyncExitStack" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">AsyncExitStack</span></code></a> class very useful:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">AsyncExitStack</span>

<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_task_group</span>


<span class="k">class</span> <span class="nc">MyAsyncContextManager</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exitstack</span> <span class="o">=</span> <span class="n">AsyncExitStack</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitstack</span><span class="o">.</span><span class="fm">__aenter__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_group</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitstack</span><span class="o">.</span><span class="n">enter_async_context</span><span class="p">(</span>
            <span class="n">create_task_group</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exitstack</span><span class="o">.</span><span class="fm">__aexit__</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="synchronization.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">使用同步原语</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="tasks.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">创建和管理任务</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2018, Alex Grönholm
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/hellowac/anyio-zh-cn" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">取消和超时</a><ul>
<li><a class="reference internal" href="#id2">超时</a></li>
<li><a class="reference internal" href="#id3">屏蔽</a></li>
<li><a class="reference internal" href="#id4">完成</a></li>
<li><a class="reference internal" href="#id5">避免取消范围堆栈损坏</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=b0668c51"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/translations.js?v=beaddf03"></script>
    <script src="_static/tabs.js?v=3030b3cb"></script>
    </body>
</html>