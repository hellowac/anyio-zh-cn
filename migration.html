<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="genindex.html" /><link rel="search" title="搜索" href="search.html" /><link rel="next" title="常见问题" href="faq.html" /><link rel="prev" title="API 参考" href="api.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>从 AnyIO 3 迁移到 AnyIO 4 - AnyIO 4.6.2 文档</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">AnyIO 4.6.2 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">AnyIO 4.6.2 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basics.html">基础知识</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">创建和管理任务</a></li>
<li class="toctree-l1"><a class="reference internal" href="cancellation.html">取消和超时</a></li>
<li class="toctree-l1"><a class="reference internal" href="synchronization.html">使用同步原语</a></li>
<li class="toctree-l1"><a class="reference internal" href="streams.html">流</a></li>
<li class="toctree-l1"><a class="reference internal" href="typedattrs.html">使用类型化属性</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">使用套接字和流</a></li>
<li class="toctree-l1"><a class="reference internal" href="threads.html">使用线程</a></li>
<li class="toctree-l1"><a class="reference internal" href="subprocesses.html">使用子进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="fileio.html">异步文件 I/O 支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="signals.html">接收操作系统信号</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">使用 AnyIO 进行测试</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API 参考</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">从 AnyIO 3 迁移到 AnyIO 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="#anyio-2-anyio-3">从 AnyIO 2 迁移到 AnyIO 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">获取帮助</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html#id2">报告错误</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">为 AnyIO 做出贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="versionhistory.html">版本历史</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/blob/sync-docs/cn_docs/migration.rst?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/edit/sync-docs/cn_docs/migration.rst" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="anyio-3-anyio-4">
<h1>从 AnyIO 3 迁移到 AnyIO 4<a class="headerlink" href="#anyio-3-anyio-4" title="Link to this heading">¶</a></h1>
<p><strong>Migrating from AnyIO 3 to AnyIO 4</strong></p>
<section id="id1">
<h2>非标准异常组类已被删除<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<p><strong>The non-standard exception group class was removed</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p>AnyIO 3 之前有一个自定义的 <code class="docutils literal notranslate"><span class="pre">ExceptionGroup</span></code> 类，它在 <span class="target" id="index-0"></span><a class="pep reference external" href="https://peps.python.org/pep-0654/"><strong>PEP 654</strong></a> 异常组类出现之前就已存在。这个类现在已经被移除，改为使用内置的 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#BaseExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">BaseExceptionGroup</span></code></a> 和 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#ExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ExceptionGroup</span></code></a> 类。如果您的代码曾经抛出旧的 <code class="docutils literal notranslate"><span class="pre">ExceptionGroup</span></code> 异常或捕获它，您需要切换到这些标准类。否则，您可以忽略这一部分。</p>
<p>如果您正在针对 Python 3.11 之前的版本，您需要使用 <cite>exceptiongroup_</cite> 回溯，并从 <code class="docutils literal notranslate"><span class="pre">exceptiongroup</span></code> 导入这些类之一。 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#BaseExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">BaseExceptionGroup</span></code></a> 和 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#ExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ExceptionGroup</span></code></a> 之间的唯一区别是，后者只能包含从 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#Exception" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Exception</span></code></a> 派生的异常，因此也可以通过 <code class="docutils literal notranslate"><span class="pre">except</span> <span class="pre">Exception:</span></code> 来捕获。</p>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>AnyIO 3 had its own <code class="docutils literal notranslate"><span class="pre">ExceptionGroup</span></code> class which predated the <span class="target" id="index-1"></span><a class="pep reference external" href="https://peps.python.org/pep-0654/"><strong>PEP 654</strong></a> exception
group classes. This class has now been removed in favor of the built-in
<a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#BaseExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">BaseExceptionGroup</span></code></a> and <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#ExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ExceptionGroup</span></code></a> classes. If your code was either
raising the old <code class="docutils literal notranslate"><span class="pre">ExceptionGroup</span></code> exception or catching it, you need to make the switch
to these standard classes. Otherwise you can ignore this part.</p>
<p>If you're targeting Python releases older than 3.11, you need to use the <a class="reference external" href="https://pypi.org/project/exceptiongroup/">exceptiongroup</a>
backport and import one of those classes from <code class="docutils literal notranslate"><span class="pre">exceptiongroup</span></code>. The only difference
between <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#BaseExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">BaseExceptionGroup</span></code></a> and <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#ExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ExceptionGroup</span></code></a> is that the latter can
only contain exceptions derived from <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#Exception" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">Exception</span></code></a>, and likewise can be caught with
<code class="docutils literal notranslate"><span class="pre">except</span> <span class="pre">Exception:</span></code>.</p>
</div></div>
</section>
<section id="id2">
<h2>任务组现在将单个异常包装在组中<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p><strong>Task groups now wrap single exceptions in groups</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><p>AnyIO 4 中最显著的不兼容变更是，任务组现在总是会在主任务或任何子任务抛出异常时（除了取消异常）抛出异常组。以前，只有当任务组需要抛出多个异常时，才会抛出异常组。实际上，这意味着如果您的代码以前期望捕获从任务组中抛出的特定类型异常，您现在需要切换到 <code class="docutils literal notranslate"><span class="pre">except*</span></code> 语法（如果您恰好使用的是 Python 3.11 或更高版本），或者使用 <cite>exceptiongroup_</cite> 回溯中的 <code class="docutils literal notranslate"><span class="pre">catch()</span></code> 上下文管理器。</p>
<p>因此，如果您的代码像这样:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">function_using_a_taskgroup</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>那么 Python 3.11+ 版本的等效代码几乎是一样的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">function_using_a_taskgroup</span><span class="p">()</span>
<span class="k">except</span><span class="o">*</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">excgrp</span><span class="p">:</span>
    <span class="c1"># 注意：excgrp 现在是一个 ExceptionGroup！</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>如果您需要保持与较旧 Python 版本的兼容性，您需要使用回溯版本:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">exceptiongroup</span> <span class="kn">import</span> <span class="n">ExceptionGroup</span><span class="p">,</span> <span class="n">catch</span>

<span class="k">def</span> <span class="nf">handle_value_errors</span><span class="p">(</span><span class="n">excgrp</span><span class="p">:</span> <span class="n">ExceptionGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="o">...</span>

<span class="k">with</span> <span class="n">catch</span><span class="p">({</span><span class="ne">ValueError</span><span class="p">:</span> <span class="n">handle_value_errors</span><span class="p">}):</span>
    <span class="k">await</span> <span class="n">function_using_a_taskgroup</span><span class="p">()</span>
</pre></div>
</div>
<p>这个差异通常也会出现在测试套件中。例如，如果您以前在基于 pytest 的测试套件中有如下代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">function_using_a_taskgroup</span><span class="p">()</span>
</pre></div>
</div>
<p>现在需要改成:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">exceptiongroup</span> <span class="kn">import</span> <span class="n">ExceptionGroup</span>

<span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">ExceptionGroup</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">function_using_a_taskgroup</span><span class="p">()</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">exceptions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">exceptions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="ne">ValueError</span><span class="p">)</span>
</pre></div>
</div>
<p>如果您需要保持与 AnyIO 3 和 4 的兼容性，可以使用以下兼容性代码，通过解包来“折叠”单一异常组:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generator</span>

<span class="n">has_exceptiongroups</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">exceptiongroup</span> <span class="kn">import</span> <span class="n">BaseExceptionGroup</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">has_exceptiongroups</span> <span class="o">=</span> <span class="kc">False</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">collapse_excgroups</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">has_exceptiongroups</span><span class="p">:</span>
            <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">BaseExceptionGroup</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">exceptions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">exceptions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">raise</span> <span class="n">exc</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><p>The most prominent backwards incompatible change in AnyIO 4 was that task groups now
always raise exception groups when either the host task or any child tasks raise an
exception (other than a cancellation exception). Previously, an exception group was only
raised when more than one exception needed to be raised from the task group. The
practical consequence is that if your code previously expected to catch a specific kind
of exception falling out of a task group, you now need to either switch to the
<code class="docutils literal notranslate"><span class="pre">except*</span></code> syntax (if you're fortunate enough to work solely with Python 3.11 or
later), or use the <code class="docutils literal notranslate"><span class="pre">catch()</span></code> context manager from the <a class="reference external" href="https://pypi.org/project/exceptiongroup/">exceptiongroup</a> backport.</p>
<p>So, if you had code like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">function_using_a_taskgroup</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>The Python 3.11+ equivalent would look almost the same:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">function_using_a_taskgroup</span><span class="p">()</span>
<span class="k">except</span><span class="o">*</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">excgrp</span><span class="p">:</span>
    <span class="c1"># Note: excgrp is an ExceptionGroup now!</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>If you need to stay compatible with older Python releases, you need to use the
backport:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">exceptiongroup</span> <span class="kn">import</span> <span class="n">ExceptionGroup</span><span class="p">,</span> <span class="n">catch</span>

<span class="k">def</span> <span class="nf">handle_value_errors</span><span class="p">(</span><span class="n">excgrp</span><span class="p">:</span> <span class="n">ExceptionGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="o">...</span>

<span class="k">with</span> <span class="n">catch</span><span class="p">({</span><span class="ne">ValueError</span><span class="p">:</span> <span class="n">handle_value_errors</span><span class="p">}):</span>
    <span class="k">await</span> <span class="n">function_using_a_taskgroup</span><span class="p">()</span>
</pre></div>
</div>
<p>This difference often comes up in test suites too. For example, if you had this before
in a pytest-based test suite:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="ne">ValueError</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">function_using_a_taskgroup</span><span class="p">()</span>
</pre></div>
</div>
<p>You now need to change it to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">exceptiongroup</span> <span class="kn">import</span> <span class="n">ExceptionGroup</span>

<span class="k">with</span> <span class="n">pytest</span><span class="o">.</span><span class="n">raises</span><span class="p">(</span><span class="n">ExceptionGroup</span><span class="p">)</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
    <span class="k">await</span> <span class="n">function_using_a_taskgroup</span><span class="p">()</span>

<span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">exceptions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
<span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">exceptions</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="ne">ValueError</span><span class="p">)</span>
</pre></div>
</div>
<p>If you need to stay compatible with both AnyIO 3 and 4, you can use the following
compatibility code to &quot;collapse&quot; single-exception groups by unwrapping them:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generator</span>

<span class="n">has_exceptiongroups</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">11</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">exceptiongroup</span> <span class="kn">import</span> <span class="n">BaseExceptionGroup</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">has_exceptiongroups</span> <span class="o">=</span> <span class="kc">False</span>


<span class="nd">@contextmanager</span>
<span class="k">def</span> <span class="nf">collapse_excgroups</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Generator</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">has_exceptiongroups</span><span class="p">:</span>
            <span class="k">while</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">BaseExceptionGroup</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">exceptions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">exc</span> <span class="o">=</span> <span class="n">exc</span><span class="o">.</span><span class="n">exceptions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">raise</span> <span class="n">exc</span>
</pre></div>
</div>
</div></div>
</section>
<section id="changed">
<h2>类型注释内存对象流的语法已更改changed<a class="headerlink" href="#changed" title="Link to this heading">¶</a></h2>
<p><a href="#id3"><span class="problematic" id="id4">**</span></a>Syntax for type annotated memory object streams has **</p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><p>以前，创建类型注解的内存对象流是通过将所需的类型作为第二个参数传递来实现的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">send</span><span class="p">,</span> <span class="n">receive</span> <span class="o">=</span> <span class="n">create_memory_object_stream</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
<p>在 4.0 中，<a class="reference internal" href="api.html#anyio.create_memory_object_stream" title="anyio.create_memory_object_stream"><code class="xref py py-class docutils literal notranslate"><span class="pre">create_memory_object_stream()</span></code></a> 是一个伪装成函数的类，因此你需要为它提供类型参数化:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">send</span><span class="p">,</span> <span class="n">receive</span> <span class="o">=</span> <span class="n">create_memory_object_stream</span>
</pre></div>
</div>
<p>如果您以前没有为您的内存对象流进行类型参数化，那么在这方面不需要进行任何更改。</p>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><p>Where previously, creating type annotated memory object streams worked by passing the
desired type as the second argument:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">send</span><span class="p">,</span> <span class="n">receive</span> <span class="o">=</span> <span class="n">create_memory_object_stream</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
</pre></div>
</div>
<p>In 4.0, <a class="reference internal" href="api.html#anyio.create_memory_object_stream" title="anyio.create_memory_object_stream"><code class="xref py py-class docutils literal notranslate"><span class="pre">create_memory_object_stream()</span></code></a> is a class
masquerading as a function, so you need to parametrize it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">send</span><span class="p">,</span> <span class="n">receive</span> <span class="o">=</span> <span class="n">create_memory_object_stream</span><span class="p">[</span><span class="nb">int</span><span class="p">](</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
<p>If you didn't parametrize your memory object streams before, then you don't need to make
any changes in this regard.</p>
</div></div>
</section>
<section id="id5">
<h2>事件循环工厂而不是事件循环策略<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h2>
<p><strong>Event loop factories instead of event loop policies</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><p>如果你正在使用自定义的 asyncio 事件循环策略与 <a class="reference internal" href="api.html#anyio.run" title="anyio.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">run()</span></code></a> 一起，你需要改为传递一个 <em>事件循环工厂(event loop factory)</em>，即一个返回新事件循环的可调用对象。</p>
<p>以 <a class="reference external" href="https://github.com/MagicStack/uvloop">uvloop</a> 为例，像以下这样的代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">anyio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">backend_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;event_loop_policy&quot;</span><span class="p">:</span> <span class="n">uvloop</span><span class="o">.</span><span class="n">EventLoopPolicy</span><span class="p">()})</span>
</pre></div>
</div>
<p>应该转换为:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">anyio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">backend_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loop_factory&quot;</span><span class="p">:</span> <span class="n">uvloop</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">})</span>
</pre></div>
</div>
<p>确保不要实际调用工厂函数！</p>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><p>If you're using a custom asyncio event loop policy with <a class="reference internal" href="api.html#anyio.run" title="anyio.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">run()</span></code></a>, you need to switch
to passing an <em>event loop factory</em>, that is, a callable that returns a new event loop.</p>
<p>Using <a class="reference external" href="https://github.com/MagicStack/uvloop">uvloop</a> as an example, code like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">anyio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">backend_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;event_loop_policy&quot;</span><span class="p">:</span> <span class="n">uvloop</span><span class="o">.</span><span class="n">EventLoopPolicy</span><span class="p">()})</span>
</pre></div>
</div>
<p>should be converted into:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">anyio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">backend_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;loop_factory&quot;</span><span class="p">:</span> <span class="n">uvloop</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">})</span>
</pre></div>
</div>
<p>Make sure not to actually call the factory function!</p>
</div></div>
</section>
</section>
<section id="anyio-2-anyio-3">
<h1>从 AnyIO 2 迁移到 AnyIO 3<a class="headerlink" href="#anyio-2-anyio-3" title="Link to this heading">¶</a></h1>
<p><strong>Migrating from AnyIO 2 to AnyIO 3</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><p>AnyIO 3 更改了一些函数和方法，这需要你在代码中进行相应的调整。所有已弃用的函数和方法将在 AnyIO 4 中被移除。</p>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><p>AnyIO 3 changed some functions and methods in a way that needs some adaptation in your
code. All deprecated functions and methods will be removed in AnyIO 4.</p>
</div></div>
<section id="id6">
<h2>异步函数转换为同步<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h2>
<p><strong>Asynchronous functions converted to synchronous</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-5-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-5-5-0" name="5-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-5-5-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-5-5-1" name="5-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-5-5-0" class="sphinx-tabs-panel" id="panel-5-5-0" name="5-0" role="tabpanel" tabindex="0"><p>AnyIO 3 将几个先前的异步函数和方法更改为常规函数，原因有以下两点：</p>
<ol class="arabic simple">
<li><p>更好地满足第三方库使用同步回调的用例需求。</p></li>
<li><p>更好地匹配 <a class="reference external" href="https://github.com/python-trio/trio">Trio</a> 的 API。</p></li>
</ol>
<p>以下函数和方法已被更改：</p>
<ul class="simple">
<li><p><a class="reference internal" href="api.html#anyio.current_time" title="anyio.current_time"><code class="xref py py-func docutils literal notranslate"><span class="pre">current_time()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.current_effective_deadline" title="anyio.current_effective_deadline"><code class="xref py py-func docutils literal notranslate"><span class="pre">current_effective_deadline()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.CancelScope.cancel" title="anyio.CancelScope.cancel"><code class="xref py py-meth docutils literal notranslate"><span class="pre">CancelScope.cancel()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.CapacityLimiter.acquire_nowait" title="anyio.CapacityLimiter.acquire_nowait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">CapacityLimiter.acquire_nowait()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.CapacityLimiter.acquire_on_behalf_of_nowait" title="anyio.CapacityLimiter.acquire_on_behalf_of_nowait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">CapacityLimiter.acquire_on_behalf_of_nowait()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.Condition.release" title="anyio.Condition.release"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Condition.release()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.Event.set" title="anyio.Event.set"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Event.set()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.get_current_task" title="anyio.get_current_task"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_current_task()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.get_running_tasks" title="anyio.get_running_tasks"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_running_tasks()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.Lock.release" title="anyio.Lock.release"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Lock.release()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.streams.memory.MemoryObjectReceiveStream.receive_nowait" title="anyio.streams.memory.MemoryObjectReceiveStream.receive_nowait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryObjectReceiveStream.receive_nowait()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.streams.memory.MemoryObjectSendStream.send_nowait" title="anyio.streams.memory.MemoryObjectSendStream.send_nowait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryObjectSendStream.send_nowait()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.open_signal_receiver" title="anyio.open_signal_receiver"><code class="xref py py-func docutils literal notranslate"><span class="pre">open_signal_receiver()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.Semaphore.release" title="anyio.Semaphore.release"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Semaphore.release()</span></code></a></p></li>
</ul>
<p>在迁移到 AnyIO 3 时，只需去掉每个调用中的 <code class="docutils literal notranslate"><span class="pre">await</span></code>。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>出于向后兼容性原因，<a class="reference internal" href="api.html#anyio.current_time" title="anyio.current_time"><code class="xref py py-func docutils literal notranslate"><span class="pre">current_time()</span></code></a>、<a class="reference internal" href="api.html#anyio.current_effective_deadline" title="anyio.current_effective_deadline"><code class="xref py py-func docutils literal notranslate"><span class="pre">current_effective_deadline()</span></code></a> 和 <a class="reference internal" href="api.html#anyio.get_running_tasks" title="anyio.get_running_tasks"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_running_tasks()</span></code></a> 返回的对象是其原始类型的可等待版本（分别为 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#float" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">float</span></code></a> 和 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#list" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">list</span></code></a>）。这些可等待版本是原始类型的子类，因此它们应与原始版本表现一致。但如果你绝对需要原始类型，可以根据需要对返回值使用 <code class="docutils literal notranslate"><span class="pre">maybe_async</span></code> 或 <code class="docutils literal notranslate"><span class="pre">float()</span></code> / <code class="docutils literal notranslate"><span class="pre">list()</span></code>。</p>
</div>
<p>以下异步上下文管理器改为常规上下文管理器：</p>
<ul class="simple">
<li><p><a class="reference internal" href="api.html#anyio.fail_after" title="anyio.fail_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">fail_after()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.move_on_after" title="anyio.move_on_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">move_on_after()</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">open_cancel_scope()``（现为</span> <span class="pre">``CancelScope()</span></code>）</p></li>
</ul>
<p>在迁移时，只需将 <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span></code> 更改为普通的 <code class="docutils literal notranslate"><span class="pre">with</span></code>。</p>
<p>除了
<a class="reference internal" href="api.html#anyio.streams.memory.MemoryObjectReceiveStream.receive_nowait" title="anyio.streams.memory.MemoryObjectReceiveStream.receive_nowait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryObjectReceiveStream.receive_nowait()</span></code></a>
以外，它们都可以继续按原样使用——不过在 AnyIO 3 上以这种方式使用时将引发 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#DeprecationWarning" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">DeprecationWarning</span></code></a>。</p>
<p>如果你在编写需要兼容两个主要版本的库，则需要使用 AnyIO 2.2 中添加的兼容性函数：<code class="docutils literal notranslate"><span class="pre">maybe_async()</span></code> 和 <code class="docutils literal notranslate"><span class="pre">maybe_async_cm()</span></code>。它们分别允许你安全地使用函数/方法和上下文管理器，而不论当前安装的是哪个主要版本。</p>
<p>示例 1 —— 设置事件:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio.abc</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">maybe_async</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">maybe_async</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">())</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>示例 2 —— 打开取消作用域:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">CancelScope</span><span class="p">,</span> <span class="n">maybe_async_cm</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">maybe_async_cm</span><span class="p">(</span><span class="n">CancelScope</span><span class="p">())</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-5-5-1" class="sphinx-tabs-panel" hidden="true" id="panel-5-5-1" name="5-1" role="tabpanel" tabindex="0"><p>AnyIO 3 changed several previously asynchronous functions and methods into regular ones
for two reasons:</p>
<p>#. to better serve use cases where synchronous callbacks are used by third party
libraries
#. to better match the API of <a class="reference external" href="https://github.com/python-trio/trio">Trio</a></p>
<p>The following functions and methods were changed:</p>
<ul class="simple">
<li><p><a class="reference internal" href="api.html#anyio.current_time" title="anyio.current_time"><code class="xref py py-func docutils literal notranslate"><span class="pre">current_time()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.current_effective_deadline" title="anyio.current_effective_deadline"><code class="xref py py-func docutils literal notranslate"><span class="pre">current_effective_deadline()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.CancelScope.cancel" title="anyio.CancelScope.cancel"><code class="xref py py-meth docutils literal notranslate"><span class="pre">CancelScope.cancel()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.CapacityLimiter.acquire_nowait" title="anyio.CapacityLimiter.acquire_nowait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">CapacityLimiter.acquire_nowait()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.CapacityLimiter.acquire_on_behalf_of_nowait" title="anyio.CapacityLimiter.acquire_on_behalf_of_nowait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">CapacityLimiter.acquire_on_behalf_of_nowait()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.Condition.release" title="anyio.Condition.release"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Condition.release()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.Event.set" title="anyio.Event.set"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Event.set()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.get_current_task" title="anyio.get_current_task"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_current_task()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.get_running_tasks" title="anyio.get_running_tasks"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_running_tasks()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.Lock.release" title="anyio.Lock.release"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Lock.release()</span></code></a></p></li>
<li><p>:meth:<a href="#id7"><span class="problematic" id="id8">`</span></a>MemoryObjectReceiveStream.receive_nowait()</p></li>
</ul>
<p>&lt;.streams.memory.MemoryObjectReceiveStream.receive_nowait&gt;`
* <a class="reference internal" href="api.html#anyio.streams.memory.MemoryObjectSendStream.send_nowait" title="anyio.streams.memory.MemoryObjectSendStream.send_nowait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryObjectSendStream.send_nowait()</span></code></a>
* <a class="reference internal" href="api.html#anyio.open_signal_receiver" title="anyio.open_signal_receiver"><code class="xref py py-func docutils literal notranslate"><span class="pre">open_signal_receiver()</span></code></a>
* <a class="reference internal" href="api.html#anyio.Semaphore.release" title="anyio.Semaphore.release"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Semaphore.release()</span></code></a></p>
<p>When migrating to AnyIO 3, simply remove the <code class="docutils literal notranslate"><span class="pre">await</span></code> from each call to these.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>For backwards compatibility reasons, <a class="reference internal" href="api.html#anyio.current_time" title="anyio.current_time"><code class="xref py py-func docutils literal notranslate"><span class="pre">current_time()</span></code></a>,</p>
</div>
<p><a class="reference internal" href="api.html#anyio.current_effective_deadline" title="anyio.current_effective_deadline"><code class="xref py py-func docutils literal notranslate"><span class="pre">current_effective_deadline()</span></code></a> and <a class="reference internal" href="api.html#anyio.get_running_tasks" title="anyio.get_running_tasks"><code class="xref py py-func docutils literal notranslate"><span class="pre">get_running_tasks()</span></code></a> return objects which
are awaitable versions of their original types (<a class="reference external" href="https://docs.python.org/zh-cn/3/library/functions.html#float" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">float</span></code></a> and <a class="reference external" href="https://docs.python.org/zh-cn/3/library/stdtypes.html#list" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">list</span></code></a>,
respectively). These awaitable versions are subclasses of the original types so they
should behave as their originals, but if you absolutely need the pristine original
types, you can either use <code class="docutils literal notranslate"><span class="pre">maybe_async</span></code> or <code class="docutils literal notranslate"><span class="pre">float()</span></code> / <code class="docutils literal notranslate"><span class="pre">list()</span></code> on the returned
value as appropriate.</p>
<p>The following async context managers changed to regular context managers:</p>
<ul class="simple">
<li><p><a class="reference internal" href="api.html#anyio.fail_after" title="anyio.fail_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">fail_after()</span></code></a></p></li>
<li><p><a class="reference internal" href="api.html#anyio.move_on_after" title="anyio.move_on_after"><code class="xref py py-func docutils literal notranslate"><span class="pre">move_on_after()</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">open_cancel_scope()</span></code> (now just <code class="docutils literal notranslate"><span class="pre">CancelScope()</span></code>)</p></li>
</ul>
<p>When migrating, just change <code class="docutils literal notranslate"><span class="pre">async</span> <span class="pre">with</span></code> into a plain <code class="docutils literal notranslate"><span class="pre">with</span></code>.</p>
<p>With the exception of
<a class="reference internal" href="api.html#anyio.streams.memory.MemoryObjectReceiveStream.receive_nowait" title="anyio.streams.memory.MemoryObjectReceiveStream.receive_nowait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MemoryObjectReceiveStream.receive_nowait()</span></code></a>,
all of them can still be used like before – they will raise <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#DeprecationWarning" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">DeprecationWarning</span></code></a>
when used this way on AnyIO 3, however.</p>
<p>If you're writing a library that needs to be compatible with both major releases, you
will need to use the compatibility functions added in AnyIO 2.2: <code class="docutils literal notranslate"><span class="pre">maybe_async()</span></code> and
<code class="docutils literal notranslate"><span class="pre">maybe_async_cm()</span></code>. These will let you safely use functions/methods and context
managers (respectively) regardless of which major release is currently installed.</p>
<p>Example 1 – setting an event:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio.abc</span> <span class="kn">import</span> <span class="n">Event</span>
<span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">maybe_async</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">):</span>
    <span class="k">await</span> <span class="n">maybe_async</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">())</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Example 2 – opening a cancel scope:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">CancelScope</span><span class="p">,</span> <span class="n">maybe_async_cm</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">maybe_async_cm</span><span class="p">(</span><span class="n">CancelScope</span><span class="p">())</span> <span class="k">as</span> <span class="n">scope</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id9">
<h2>启动任务<a class="headerlink" href="#id9" title="Link to this heading">¶</a></h2>
<p><strong>Starting tasks</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-6-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-6-6-0" name="6-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-6-6-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-6-6-1" name="6-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-6-6-0" class="sphinx-tabs-panel" id="panel-6-6-0" name="6-0" role="tabpanel" tabindex="0"><p><code class="docutils literal notranslate"><span class="pre">TaskGroup.spawn()</span></code> 协程方法已被弃用，推荐使用同步方法 <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start_soon" title="anyio.abc.TaskGroup.start_soon"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start_soon()</span></code></a> （该方法与 Trio 的 “nurseries” 中的 <code class="docutils literal notranslate"><span class="pre">start_soon()</span></code> 方法相对应）。如果你完全迁移到 AnyIO 3，只需切换到调用新方法（并去掉 <code class="docutils literal notranslate"><span class="pre">await</span></code>）。</p>
<p>如果代码需要兼容 AnyIO 2 和 3，你可以继续使用 <a href="#id10"><span class="problematic" id="id11">``</span></a>TaskGroup.spawn()``（直到 AnyIO 4）并抑制弃用警告:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">tg</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">otherfunc</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-6-6-1" class="sphinx-tabs-panel" hidden="true" id="panel-6-6-1" name="6-1" role="tabpanel" tabindex="0"><p>The <code class="docutils literal notranslate"><span class="pre">TaskGroup.spawn()</span></code> coroutine method has been deprecated in favor of the
synchronous method <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start_soon" title="anyio.abc.TaskGroup.start_soon"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start_soon()</span></code></a> (which mirrors <code class="docutils literal notranslate"><span class="pre">start_soon()</span></code> in
Trio's nurseries). If you're fully migrating to AnyIO 3, simply switch to calling the
new method (and remove the <code class="docutils literal notranslate"><span class="pre">await</span></code>).</p>
<p>If your code needs to work with both AnyIO 2 and 3, you can keep using
<code class="docutils literal notranslate"><span class="pre">TaskGroup.spawn()</span></code> (until AnyIO 4) and suppress the deprecation warning:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">tg</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">otherfunc</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id12">
<h2>阻止门户更改<a class="headerlink" href="#id12" title="Link to this heading">¶</a></h2>
<p><strong>Blocking portal changes</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-7-7-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-7-7-0" name="7-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-7-7-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-7-7-1" name="7-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-7-7-0" class="sphinx-tabs-panel" id="panel-7-7-0" name="7-0" role="tabpanel" tabindex="0"><p>AnyIO 现在**要求** <a class="reference internal" href="api.html#anyio.from_thread.start_blocking_portal" title="anyio.from_thread.start_blocking_portal"><code class="xref py py-func docutils literal notranslate"><span class="pre">from_thread.start_blocking_portal()</span></code></a> 作为上下文管理器使用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">start_blocking_portal</span>

<span class="k">with</span> <span class="n">start_blocking_portal</span><span class="p">()</span> <span class="k">as</span> <span class="n">portal</span><span class="p">:</span>
    <span class="n">portal</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sleep</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>与 <code class="docutils literal notranslate"><span class="pre">TaskGroup.spawn()</span></code> 类似， <code class="docutils literal notranslate"><span class="pre">BlockingPortal.spawn_task()</span></code> 方法也已重命名为 <a class="reference internal" href="api.html#anyio.from_thread.BlockingPortal.start_task_soon" title="anyio.from_thread.BlockingPortal.start_task_soon"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start_task_soon()</span></code></a>，以便与任务组一致。</p>
<p><code class="docutils literal notranslate"><span class="pre">create_blocking_portal()</span></code> 工厂函数也被弃用，建议直接实例化 <a class="reference internal" href="api.html#anyio.from_thread.BlockingPortal" title="anyio.from_thread.BlockingPortal"><code class="xref py py-class docutils literal notranslate"><span class="pre">BlockingPortal</span></code></a>。</p>
<p>对于需要跨版本兼容的代码，可以通过捕获弃用警告（如上所示）来处理。</p>
</div><div aria-labelledby="tab-7-7-1" class="sphinx-tabs-panel" hidden="true" id="panel-7-7-1" name="7-1" role="tabpanel" tabindex="0"><p>AnyIO now <strong>requires</strong> <a class="reference internal" href="api.html#anyio.from_thread.start_blocking_portal" title="anyio.from_thread.start_blocking_portal"><code class="xref py py-func docutils literal notranslate"><span class="pre">from_thread.start_blocking_portal()</span></code></a> to be used as a
context manager:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">sleep</span>
<span class="kn">from</span> <span class="nn">anyio.from_thread</span> <span class="kn">import</span> <span class="n">start_blocking_portal</span>

<span class="k">with</span> <span class="n">start_blocking_portal</span><span class="p">()</span> <span class="k">as</span> <span class="n">portal</span><span class="p">:</span>
    <span class="n">portal</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">sleep</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>As with <code class="docutils literal notranslate"><span class="pre">TaskGroup.spawn()</span></code>, the <code class="docutils literal notranslate"><span class="pre">BlockingPortal.spawn_task()</span></code> method has also been
renamed to <a class="reference internal" href="api.html#anyio.from_thread.BlockingPortal.start_task_soon" title="anyio.from_thread.BlockingPortal.start_task_soon"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start_task_soon()</span></code></a>, so as to be consistent
with task groups.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">create_blocking_portal()</span></code> factory function was also deprecated in favor of
instantiating <a class="reference internal" href="api.html#anyio.from_thread.BlockingPortal" title="anyio.from_thread.BlockingPortal"><code class="xref py py-class docutils literal notranslate"><span class="pre">BlockingPortal</span></code></a> directly.</p>
<p>For code requiring cross compatibility, catching the deprecation warning (as above)
should work.</p>
</div></div>
</section>
<section id="id13">
<h2>同步原语<a class="headerlink" href="#id13" title="Link to this heading">¶</a></h2>
<p><strong>Synchronization primitives</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-8-8-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-8-8-0" name="8-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-8-8-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-8-8-1" name="8-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-8-8-0" class="sphinx-tabs-panel" id="panel-8-8-0" name="8-0" role="tabpanel" tabindex="0"><p>同步原语工厂函数（如 <code class="docutils literal notranslate"><span class="pre">create_event()</span></code> 等）已被弃用，建议直接实例化类。因此，将如下代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_event</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">create_event</span><span class="p">()</span>
</pre></div>
</div>
<p>转换为:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Event</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
</pre></div>
</div>
<p>或者，如果需要兼容 AnyIO 2 和 3，则可以这样处理:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Event</span>
    <span class="n">create_event</span> <span class="o">=</span> <span class="n">Event</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_event</span>
    <span class="kn">from</span> <span class="nn">anyio.abc</span> <span class="kn">import</span> <span class="n">Event</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Event</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">create_event</span><span class="p">()</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-8-8-1" class="sphinx-tabs-panel" hidden="true" id="panel-8-8-1" name="8-1" role="tabpanel" tabindex="0"><p>Synchronization primitive factories (<code class="docutils literal notranslate"><span class="pre">create_event()</span></code> etc.) were deprecated in favor
of instantiating the classes directly. So convert code like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_event</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">create_event</span><span class="p">()</span>
</pre></div>
</div>
<p>into this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Event</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
</pre></div>
</div>
<p>or, if you need to work with both AnyIO 2 and 3:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Event</span>
    <span class="n">create_event</span> <span class="o">=</span> <span class="n">Event</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_event</span>
    <span class="kn">from</span> <span class="nn">anyio.abc</span> <span class="kn">import</span> <span class="n">Event</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Event</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">create_event</span><span class="p">()</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id14">
<h2>线程函数已移动<a class="headerlink" href="#id14" title="Link to this heading">¶</a></h2>
<p><strong>Threading functions moved</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-9-9-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-9-9-0" name="9-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-9-9-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-9-9-1" name="9-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-9-9-0" class="sphinx-tabs-panel" id="panel-9-9-0" name="9-0" role="tabpanel" tabindex="0"><p>线程函数已被重构至子模块，参考了 Trio 的模块化方式：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">current_default_worker_thread_limiter</span></code> → <a class="reference internal" href="api.html#anyio.to_thread.current_default_thread_limiter" title="anyio.to_thread.current_default_thread_limiter"><code class="xref py py-func docutils literal notranslate"><span class="pre">to_thread.current_default_thread_limiter()</span></code></a> （注意：函数名称也被重命名！）</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_sync_in_worker_thread()</span></code> → <a class="reference internal" href="api.html#anyio.to_thread.run_sync" title="anyio.to_thread.run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">to_thread.run_sync()</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_async_from_thread()</span></code> → <a class="reference internal" href="api.html#anyio.from_thread.run" title="anyio.from_thread.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">from_thread.run()</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_sync_from_thread()</span></code> → <a class="reference internal" href="api.html#anyio.from_thread.run_sync" title="anyio.from_thread.run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">from_thread.run_sync()</span></code></a></p></li>
</ul>
<p>旧版本函数仍可使用，但调用时会发出弃用警告。</p>
</div><div aria-labelledby="tab-9-9-1" class="sphinx-tabs-panel" hidden="true" id="panel-9-9-1" name="9-1" role="tabpanel" tabindex="0"><p>Threading functions were restructured to submodules, following the example of Trio:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">current_default_worker_thread_limiter</span></code> → <a class="reference internal" href="api.html#anyio.to_thread.current_default_thread_limiter" title="anyio.to_thread.current_default_thread_limiter"><code class="xref py py-func docutils literal notranslate"><span class="pre">to_thread.current_default_thread_limiter()</span></code></a> (NOTE: the function was renamed too!)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_sync_in_worker_thread()</span></code> → <a class="reference internal" href="api.html#anyio.to_thread.run_sync" title="anyio.to_thread.run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">to_thread.run_sync()</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_async_from_thread()</span></code> → <a class="reference internal" href="api.html#anyio.from_thread.run" title="anyio.from_thread.run"><code class="xref py py-func docutils literal notranslate"><span class="pre">from_thread.run()</span></code></a></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">run_sync_from_thread()</span></code> → <a class="reference internal" href="api.html#anyio.from_thread.run_sync" title="anyio.from_thread.run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">from_thread.run_sync()</span></code></a></p></li>
</ul>
<p>The old versions are still in place but emit deprecation warnings when called.</p>
</div></div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="faq.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">常见问题</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="api.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">API 参考</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2018, Alex Grönholm
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/hellowac/anyio-zh-cn" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">从 AnyIO 3 迁移到 AnyIO 4</a><ul>
<li><a class="reference internal" href="#id1">非标准异常组类已被删除</a></li>
<li><a class="reference internal" href="#id2">任务组现在将单个异常包装在组中</a></li>
<li><a class="reference internal" href="#changed">类型注释内存对象流的语法已更改changed</a></li>
<li><a class="reference internal" href="#id5">事件循环工厂而不是事件循环策略</a></li>
</ul>
</li>
<li><a class="reference internal" href="#anyio-2-anyio-3">从 AnyIO 2 迁移到 AnyIO 3</a><ul>
<li><a class="reference internal" href="#id6">异步函数转换为同步</a></li>
<li><a class="reference internal" href="#id9">启动任务</a></li>
<li><a class="reference internal" href="#id12">阻止门户更改</a></li>
<li><a class="reference internal" href="#id13">同步原语</a></li>
<li><a class="reference internal" href="#id14">线程函数已移动</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=b0668c51"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/translations.js?v=beaddf03"></script>
    <script src="_static/tabs.js?v=3030b3cb"></script>
    </body>
</html>