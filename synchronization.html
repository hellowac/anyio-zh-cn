<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="genindex.html" /><link rel="search" title="搜索" href="search.html" /><link rel="next" title="流" href="streams.html" /><link rel="prev" title="取消和超时" href="cancellation.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>使用同步原语 - AnyIO 4.6.2 文档</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">AnyIO 4.6.2 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">AnyIO 4.6.2 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basics.html">基础知识</a></li>
<li class="toctree-l1"><a class="reference internal" href="tasks.html">创建和管理任务</a></li>
<li class="toctree-l1"><a class="reference internal" href="cancellation.html">取消和超时</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">使用同步原语</a></li>
<li class="toctree-l1"><a class="reference internal" href="streams.html">流</a></li>
<li class="toctree-l1"><a class="reference internal" href="typedattrs.html">使用类型化属性</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">使用套接字和流</a></li>
<li class="toctree-l1"><a class="reference internal" href="threads.html">使用线程</a></li>
<li class="toctree-l1"><a class="reference internal" href="subprocesses.html">使用子进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="fileio.html">异步文件 I/O 支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="signals.html">接收操作系统信号</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">使用 AnyIO 进行测试</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API 参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html">从 AnyIO 3 迁移到 AnyIO 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html#anyio-2-anyio-3">从 AnyIO 2 迁移到 AnyIO 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">获取帮助</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html#id2">报告错误</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">为 AnyIO 做出贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="versionhistory.html">版本历史</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/blob/sync-docs/cn_docs/synchronization.rst?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/edit/sync-docs/cn_docs/synchronization.rst" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="id1">
<h1>使用同步原语<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h1>
<p><strong>Using synchronization primitives</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p>同步原语是任务用来相互通信和协调的对象。它们对于分配工作负载、通知其他任务以及保护对共享资源的访问等操作非常有用。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>AnyIO 原语不是线程安全的，因此不应直接从工作线程中使用。对于这种情况，请使用 <a class="reference internal" href="api.html#anyio.from_thread.run_sync" title="anyio.from_thread.run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_sync()</span></code></a> 。</p>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>Synchronization primitives are objects that are used by tasks to communicate and
coordinate with each other. They are useful for things like distributing workload,
notifying other tasks and guarding access to shared resources.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>AnyIO primitives are not thread-safe, therefore they should not be used</p>
</div>
<p>directly from worker threads.  Use <a class="reference internal" href="api.html#anyio.from_thread.run_sync" title="anyio.from_thread.run_sync"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_sync()</span></code></a> for that.</p>
</div></div>
<section id="id2">
<h2>事件<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p><strong>Events</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><p>事件用于通知任务它们一直在等待的事情已经发生。一个事件对象可以有多个监听者，当事件被触发时，所有监听者都会被通知。</p>
<p>示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">notify</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Received notification!&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>与标准库的事件不同，AnyIO 事件不能被重用，必须被替换。这种做法防止了一类竞争条件，并且与 Trio 库的语义一致。</p>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><p>Events are used to notify tasks that something they've been waiting to happen has
happened. An event object can have multiple listeners and they are all notified when the
event is triggered.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">notify</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
    <span class="n">event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">event</span> <span class="o">=</span> <span class="n">Event</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">notify</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Received notification!&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Unlike standard library Events, AnyIO events cannot be reused, and must be
replaced instead. This practice prevents a class of race conditions, and matches the
semantics of the Trio library.</p>
</div>
</div></div>
</section>
<section id="id3">
<h2>信号量<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p><strong>Semaphores</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><p>信号量用于限制对共享资源的访问。信号量从一个最大值开始，每次任务获取信号量时，该值会递减，而释放时会递增。如果值降到零，任何获取信号量的尝试都会被阻塞，直到另一个任务释放它。</p>
<p>示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Semaphore</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">run</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">use_resource</span><span class="p">(</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">semaphore</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task number&#39;</span><span class="p">,</span> <span class="n">tasknum</span><span class="p">,</span> <span class="s1">&#39;is now working with the shared resource&#39;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">semaphore</span> <span class="o">=</span> <span class="n">Semaphore</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">use_resource</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">semaphore</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>如果信号量的性能对你来说很重要，你可以将 <code class="docutils literal notranslate"><span class="pre">fast_acquire=True</span></code> 传递给 <a class="reference internal" href="api.html#anyio.Semaphore" title="anyio.Semaphore"><code class="xref py py-class docutils literal notranslate"><span class="pre">Semaphore</span></code></a> 。这样做会跳过 <a class="reference internal" href="api.html#anyio.Semaphore.acquire" title="anyio.Semaphore.acquire"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Semaphore.acquire()</span></code></a> 中的 <a class="reference internal" href="api.html#anyio.lowlevel.cancel_shielded_checkpoint" title="anyio.lowlevel.cancel_shielded_checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">cancel_shielded_checkpoint()</span></code></a> 调用，如果没有争用（即获取信号量立即成功）。在某些情况下，这可能会导致任务在使用信号量的循环中永远不会将控制权交还给事件循环，特别是在该循环没有其他 yield 点的情况下。</p>
</div>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><p>Semaphores are used for limiting access to a shared resource. A semaphore starts with a
maximum value, which is decremented each time the semaphore is acquired by a task and
incremented when it is released. If the value drops to zero, any attempt to acquire the
semaphore will block until another task frees it.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Semaphore</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">use_resource</span><span class="p">(</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">semaphore</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">semaphore</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task number&#39;</span><span class="p">,</span> <span class="n">tasknum</span><span class="p">,</span> <span class="s1">&#39;is now working with the shared resource&#39;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">semaphore</span> <span class="o">=</span> <span class="n">Semaphore</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">use_resource</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">semaphore</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>If the performance of semaphores is critical for you, you could pass</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">fast_acquire=True</span></code> to <a class="reference internal" href="api.html#anyio.Semaphore" title="anyio.Semaphore"><code class="xref py py-class docutils literal notranslate"><span class="pre">Semaphore</span></code></a>. This has the effect of skipping the
<a class="reference internal" href="api.html#anyio.lowlevel.cancel_shielded_checkpoint" title="anyio.lowlevel.cancel_shielded_checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">cancel_shielded_checkpoint()</span></code></a> call in <a class="reference internal" href="api.html#anyio.Semaphore.acquire" title="anyio.Semaphore.acquire"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Semaphore.acquire()</span></code></a> if
there is no contention (acquisition succeeds immediately). This could, in some cases,
lead to the task never yielding control back to to the event loop if you use the
semaphore in a loop that does not have other yield points.</p>
</div></div>
</section>
<section id="id4">
<h2>锁<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h2>
<p><strong>Locks</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><p>锁用于保护共享资源，以确保每次只有一个任务能够独占访问。它们的功能类似于最大值为 1 的信号量，唯一的区别是，只有获取锁的任务才被允许释放它。</p>
<p>示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">use_resource</span><span class="p">(</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task number&#39;</span><span class="p">,</span> <span class="n">tasknum</span><span class="p">,</span> <span class="s1">&#39;is now working with the shared resource&#39;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">use_resource</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">lock</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>如果锁的性能对你来说很重要，你可以将 <code class="docutils literal notranslate"><span class="pre">fast_acquire=True</span></code> 传递给 <a class="reference internal" href="api.html#anyio.Lock" title="anyio.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a>。这样做会跳过 <a class="reference internal" href="api.html#anyio.Lock.acquire" title="anyio.Lock.acquire"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Lock.acquire()</span></code></a> 中的 <a class="reference internal" href="api.html#anyio.lowlevel.cancel_shielded_checkpoint" title="anyio.lowlevel.cancel_shielded_checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">cancel_shielded_checkpoint()</span></code></a> 调用，如果没有争用（即获取锁立即成功）。在某些情况下，这可能会导致任务在使用锁的循环中永远不会将控制权交还给事件循环，特别是在该循环没有其他 yield 点的情况下。</p>
</div>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><p>Locks are used to guard shared resources to ensure sole access to a single task at once.
They function much like semaphores with a maximum value of 1, except that only the task
that acquired the lock is allowed to release it.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Lock</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">use_resource</span><span class="p">(</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">lock</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task number&#39;</span><span class="p">,</span> <span class="n">tasknum</span><span class="p">,</span> <span class="s1">&#39;is now working with the shared resource&#39;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">use_resource</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">lock</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>If the performance of locks is critical for you, you could pass</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">fast_acquire=True</span></code> to <a class="reference internal" href="api.html#anyio.Lock" title="anyio.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a>. This has the effect of skipping the
<a class="reference internal" href="api.html#anyio.lowlevel.cancel_shielded_checkpoint" title="anyio.lowlevel.cancel_shielded_checkpoint"><code class="xref py py-func docutils literal notranslate"><span class="pre">cancel_shielded_checkpoint()</span></code></a> call in <a class="reference internal" href="api.html#anyio.Lock.acquire" title="anyio.Lock.acquire"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Lock.acquire()</span></code></a> if there
is no contention (acquisition succeeds immediately). This could, in some cases, lead
to the task never yielding control back to to the event loop if use the lock in a
loop that does not have other yield points.</p>
</div></div>
</section>
<section id="id5">
<h2>条件<a class="headerlink" href="#id5" title="Link to this heading">¶</a></h2>
<p><strong>Conditions</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><p>条件实际上是事件和锁的结合体。它首先获取一个锁，然后等待来自事件的通知。一旦条件接收到通知，它将释放锁。通知任务还可以选择一次唤醒多个监听者，甚至是所有监听者。</p>
<p>与 <a class="reference internal" href="api.html#anyio.Lock" title="anyio.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a> 类似，<a class="reference internal" href="api.html#anyio.Condition" title="anyio.Condition"><code class="xref py py-class docutils literal notranslate"><span class="pre">Condition</span></code></a> 也要求获取锁的任务必须是释放锁的任务。</p>
<p>示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Condition</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">condition</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">condition</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">condition</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Woke up task number&#39;</span><span class="p">,</span> <span class="n">tasknum</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="n">Condition</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tasknum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">listen</span><span class="p">,</span> <span class="n">tasknum</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">condition</span><span class="p">:</span>
            <span class="n">condition</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">condition</span><span class="p">:</span>
            <span class="n">condition</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">condition</span><span class="p">:</span>
            <span class="n">condition</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><p>A condition is basically a combination of an event and a lock. It first acquires a lock
and then waits for a notification from the event. Once the condition receives a
notification, it releases the lock. The notifying task can also choose to wake up more
than one listener at once, or even all of them.</p>
<p>Like <a class="reference internal" href="api.html#anyio.Lock" title="anyio.Lock"><code class="xref py py-class docutils literal notranslate"><span class="pre">Lock</span></code></a>, <a class="reference internal" href="api.html#anyio.Condition" title="anyio.Condition"><code class="xref py py-class docutils literal notranslate"><span class="pre">Condition</span></code></a> also requires that the task which locked it also
the one to release it.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">Condition</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">listen</span><span class="p">(</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">condition</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">condition</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">condition</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Woke up task number&#39;</span><span class="p">,</span> <span class="n">tasknum</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="n">Condition</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">tasknum</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">listen</span><span class="p">,</span> <span class="n">tasknum</span><span class="p">,</span> <span class="n">condition</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">condition</span><span class="p">:</span>
            <span class="n">condition</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">condition</span><span class="p">:</span>
            <span class="n">condition</span><span class="o">.</span><span class="n">notify</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">condition</span><span class="p">:</span>
            <span class="n">condition</span><span class="o">.</span><span class="n">notify_all</span><span class="p">()</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id6">
<h2>容量限制器<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h2>
<p><strong>Capacity limiters</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-5-5-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-5-5-0" name="5-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-5-5-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-5-5-1" name="5-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-5-5-0" class="sphinx-tabs-panel" id="panel-5-5-0" name="5-0" role="tabpanel" tabindex="0"><p>容量限制器类似于信号量，不同之处在于单个借用者（默认是当前任务）一次只能持有一个令牌。也可以代表任何可哈希对象借用令牌。</p>
<p>示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">CapacityLimiter</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">use_resource</span><span class="p">(</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">limiter</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">limiter</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task number&#39;</span><span class="p">,</span> <span class="n">tasknum</span><span class="p">,</span> <span class="s1">&#39;is now working with the shared resource&#39;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">limiter</span> <span class="o">=</span> <span class="n">CapacityLimiter</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">use_resource</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">limiter</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>你可以通过设置限制器的 <code class="docutils literal notranslate"><span class="pre">total_tokens</span></code> 属性来调整令牌的总数。</p>
</div><div aria-labelledby="tab-5-5-1" class="sphinx-tabs-panel" hidden="true" id="panel-5-5-1" name="5-1" role="tabpanel" tabindex="0"><p>Capacity limiters are like semaphores except that a single borrower (the current task by
default) can only hold a single token at a time. It is also possible to borrow a token
on behalf of any arbitrary object, so long as that object is hashable.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">CapacityLimiter</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">use_resource</span><span class="p">(</span><span class="n">tasknum</span><span class="p">,</span> <span class="n">limiter</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">limiter</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task number&#39;</span><span class="p">,</span> <span class="n">tasknum</span><span class="p">,</span> <span class="s1">&#39;is now working with the shared resource&#39;</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">limiter</span> <span class="o">=</span> <span class="n">CapacityLimiter</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">use_resource</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">limiter</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>You can adjust the total number of tokens by setting a different value on the limiter's
<code class="docutils literal notranslate"><span class="pre">total_tokens</span></code> property.</p>
</div></div>
</section>
<section id="id7">
<h2>资源保护器<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h2>
<p><strong>Resource guards</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-6-6-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-6-6-0" name="6-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-6-6-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-6-6-1" name="6-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-6-6-0" class="sphinx-tabs-panel" id="panel-6-6-0" name="6-0" role="tabpanel" tabindex="0"><p>某些资源，如套接字，对于并发使用非常敏感，甚至不应允许尝试并发使用。在这种情况下，<a class="reference internal" href="api.html#anyio.ResourceGuard" title="anyio.ResourceGuard"><code class="xref py py-class docutils literal notranslate"><span class="pre">ResourceGuard</span></code></a> 是合适的解决方案:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Resource</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_guard</span> <span class="o">=</span> <span class="n">ResourceGuard</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_something</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_guard</span><span class="p">:</span>
            <span class="o">...</span>
</pre></div>
</div>
<p>现在，如果另一个任务在第一个调用尚未完成之前尝试在同一个 <code class="docutils literal notranslate"><span class="pre">Resource</span></code> 实例上调用 <code class="docutils literal notranslate"><span class="pre">do_something()</span></code> 方法，这将引发 <a class="reference internal" href="api.html#anyio.BusyResourceError" title="anyio.BusyResourceError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">BusyResourceError</span></code></a>。</p>
</div><div aria-labelledby="tab-6-6-1" class="sphinx-tabs-panel" hidden="true" id="panel-6-6-1" name="6-1" role="tabpanel" tabindex="0"><p>Some resources, such as sockets, are very sensitive about concurrent use and should not
allow even attempts to be used concurrently. For such cases, <a class="reference internal" href="api.html#anyio.ResourceGuard" title="anyio.ResourceGuard"><code class="xref py py-class docutils literal notranslate"><span class="pre">ResourceGuard</span></code></a> is
the appropriate solution:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Resource</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_guard</span> <span class="o">=</span> <span class="n">ResourceGuard</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">do_something</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_guard</span><span class="p">:</span>
            <span class="o">...</span>
</pre></div>
</div>
<p>Now, if another task tries calling the <code class="docutils literal notranslate"><span class="pre">do_something()</span></code> method on the same
<code class="docutils literal notranslate"><span class="pre">Resource</span></code> instance before the first call has finished, that will raise a
<a class="reference internal" href="api.html#anyio.BusyResourceError" title="anyio.BusyResourceError"><code class="xref py py-exc docutils literal notranslate"><span class="pre">BusyResourceError</span></code></a>.</p>
</div></div>
</section>
<section id="id8">
<h2>队列<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h2>
<p><strong>Queues</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-7-7-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-7-7-0" name="7-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-7-7-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-7-7-1" name="7-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-7-7-0" class="sphinx-tabs-panel" id="panel-7-7-0" name="7-0" role="tabpanel" tabindex="0"><p>作为队列的替代，AnyIO 提供了一个更强大的构造：<a class="reference internal" href="streams.html#memory-object-streams"><span class="std std-ref">内存对象流</span></a>。</p>
</div><div aria-labelledby="tab-7-7-1" class="sphinx-tabs-panel" hidden="true" id="panel-7-7-1" name="7-1" role="tabpanel" tabindex="0"><p>In place of queues, AnyIO offers a more powerful construct:
<a class="reference internal" href="streams.html#memory-object-streams"><span class="std std-ref">memory object streams</span></a>.</p>
</div></div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="streams.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">流</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="cancellation.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">取消和超时</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2018, Alex Grönholm
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/hellowac/anyio-zh-cn" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">使用同步原语</a><ul>
<li><a class="reference internal" href="#id2">事件</a></li>
<li><a class="reference internal" href="#id3">信号量</a></li>
<li><a class="reference internal" href="#id4">锁</a></li>
<li><a class="reference internal" href="#id5">条件</a></li>
<li><a class="reference internal" href="#id6">容量限制器</a></li>
<li><a class="reference internal" href="#id7">资源保护器</a></li>
<li><a class="reference internal" href="#id8">队列</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=b0668c51"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/translations.js?v=beaddf03"></script>
    <script src="_static/tabs.js?v=3030b3cb"></script>
    </body>
</html>