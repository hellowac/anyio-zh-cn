<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="genindex.html" /><link rel="search" title="搜索" href="search.html" /><link rel="next" title="取消和超时" href="cancellation.html" /><link rel="prev" title="基础知识" href="basics.html" />

    <!-- Generated with Sphinx 8.1.3 and Furo 2024.08.06 -->
        <title>创建和管理任务 - AnyIO 4.6.2 文档</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">AnyIO 4.6.2 文档</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">AnyIO 4.6.2 文档</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="basics.html">基础知识</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">创建和管理任务</a></li>
<li class="toctree-l1"><a class="reference internal" href="cancellation.html">取消和超时</a></li>
<li class="toctree-l1"><a class="reference internal" href="synchronization.html">使用同步原语</a></li>
<li class="toctree-l1"><a class="reference internal" href="streams.html">流</a></li>
<li class="toctree-l1"><a class="reference internal" href="typedattrs.html">使用类型化属性</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking.html">使用套接字和流</a></li>
<li class="toctree-l1"><a class="reference internal" href="threads.html">使用线程</a></li>
<li class="toctree-l1"><a class="reference internal" href="subprocesses.html">使用子进程</a></li>
<li class="toctree-l1"><a class="reference internal" href="fileio.html">异步文件 I/O 支持</a></li>
<li class="toctree-l1"><a class="reference internal" href="signals.html">接收操作系统信号</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">使用 AnyIO 进行测试</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API 参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html">从 AnyIO 3 迁移到 AnyIO 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html#anyio-2-anyio-3">从 AnyIO 2 迁移到 AnyIO 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">常见问题</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html">获取帮助</a></li>
<li class="toctree-l1"><a class="reference internal" href="support.html#id2">报告错误</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">为 AnyIO 做出贡献</a></li>
<li class="toctree-l1"><a class="reference internal" href="versionhistory.html">版本历史</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/blob/sync-docs/cn_docs/tasks.rst?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/hellowac/anyio-zh-cn/edit/sync-docs/cn_docs/tasks.rst" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="id1">
<h1>创建和管理任务<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h1>
<p><strong>Creating and managing tasks</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-0-0-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-0-0-0" name="0-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-0-0-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-0-0-1" name="0-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-0-0-0" class="sphinx-tabs-panel" id="panel-0-0-0" name="0-0" role="tabpanel" tabindex="0"><p><em>任务</em> 是一个执行单元，使您能够同时处理多个需要等待的操作。尽管可以创建任意数量的任务，但异步事件循环在任一时间只能运行其中的一个。当任务遇到一个需要任务暂停等待的 <code class="docutils literal notranslate"><span class="pre">await</span></code> 语句时，事件循环便可以自由地处理其他任务。当第一个任务等待的事件完成后，事件循环将在获得机会时恢复该任务的执行。</p>
<p>AnyIO 中的任务处理大致遵循 <a class="reference external" href="https://trio.readthedocs.io/en/latest/reference-core.html#tasks-let-you-do-multiple-things-at-once">Trio</a> 模型。可以使用 <em>任务组</em> 来创建（<em>生成</em>）任务。任务组是一个异步上下文管理器，确保在退出上下文块后，其所有子任务都以某种方式完成。如果子任务或上下文块中的代码引发了异常，则所有子任务都会被取消。否则，上下文管理器会等待所有子任务退出后再继续执行。</p>
<p>示例代码如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">sometask</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task&#39;</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="s1">&#39;running&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task&#39;</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="s1">&#39;finished&#39;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">sometask</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All tasks finished!&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-0-0-1" class="sphinx-tabs-panel" hidden="true" id="panel-0-0-1" name="0-1" role="tabpanel" tabindex="0"><p>A <em>task</em> is a unit of execution that lets you do many things concurrently that need waiting on. This works so that while you can have any number of tasks, the asynchronous event loop can only run one of them at a time. When the task encounters an <code class="docutils literal notranslate"><span class="pre">await</span></code> statement that requires the task to sleep until something happens, the event loop is then free to work on another task. When the thing the first task was waiting is complete, the event loop will resume the execution of that task on the first opportunity it gets.</p>
<p>Task handling in AnyIO loosely follows the <a class="reference external" href="https://trio.readthedocs.io/en/latest/reference-core.html#tasks-let-you-do-multiple-things-at-once">Trio</a> model. Tasks can be created (<em>spawned</em>) using <em>task groups</em>. A task group is an asynchronous context manager that makes sure that all its child tasks are finished one way or another after the context block is exited. If a child task, or the code in the enclosed context block raises an exception, all child tasks are cancelled. Otherwise the context manager just waits until all child tasks have exited before proceeding.</p>
<p>Here's a demonstration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">sleep</span><span class="p">,</span> <span class="n">create_task_group</span><span class="p">,</span> <span class="n">run</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">sometask</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task&#39;</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="s1">&#39;running&#39;</span><span class="p">)</span>
    <span class="k">await</span> <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Task&#39;</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="s1">&#39;finished&#39;</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">sometask</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All tasks finished!&#39;</span><span class="p">)</span>

<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
</div></div>
<section id="id2">
<h2>启动和初始化任务<a class="headerlink" href="#id2" title="Link to this heading">¶</a></h2>
<p><strong>Starting and initializing tasks</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-1-1-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-1-1-0" name="1-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-1-1-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-1-1-1" name="1-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-1-1-0" class="sphinx-tabs-panel" id="panel-1-1-0" name="1-0" role="tabpanel" tabindex="0"><p>有时能够等待任务成功初始化自身是非常有用的。例如，在启动网络服务时，您可以让任务启动监听器，然后向调用方发出初始化完成的信号。这样，调用方可以启动依赖于该服务已启动和运行的其他任务。此外，如果套接字绑定失败或在初始化期间出现其他问题，异常会传播给调用方，从而可以捕获并处理异常。</p>
<p>这可以通过 <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start" title="anyio.abc.TaskGroup.start"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start()</span></code></a> 来实现:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TASK_STATUS_IGNORED</span><span class="p">,</span>
    <span class="n">create_task_group</span><span class="p">,</span>
    <span class="n">connect_tcp</span><span class="p">,</span>
    <span class="n">create_tcp_listener</span><span class="p">,</span>
    <span class="n">run</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">anyio.abc</span> <span class="kn">import</span> <span class="n">TaskStatus</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">start_some_service</span><span class="p">(</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">task_status</span><span class="p">:</span> <span class="n">TaskStatus</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">TASK_STATUS_IGNORED</span>
<span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">create_tcp_listener</span><span class="p">(</span>
        <span class="n">local_host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">local_port</span><span class="o">=</span><span class="n">port</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">listener</span><span class="p">:</span>
        <span class="n">task_status</span><span class="o">.</span><span class="n">started</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">listener</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">tg</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">start_some_service</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">connect_tcp</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="o">...</span>


<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>目标协程函数 <strong>必须</strong> 调用 <code class="docutils literal notranslate"><span class="pre">task_status.started()</span></code>，因为调用 <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start" title="anyio.abc.TaskGroup.start"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start()</span></code></a> 的任务将会阻塞，直到此方法被调用。如果生成的任务未调用它，那么 <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start" title="anyio.abc.TaskGroup.start"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start()</span></code></a> 调用将引发 <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>。</p>
<div class="admonition attention">
<p class="admonition-title">注意</p>
<p>与 <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start_soon" title="anyio.abc.TaskGroup.start_soon"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start_soon()</span></code></a> 不同，<a class="reference internal" href="api.html#anyio.abc.TaskGroup.start" title="anyio.abc.TaskGroup.start"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start()</span></code></a> 需要使用 <code class="docutils literal notranslate"><span class="pre">await</span></code>。</p>
</div>
</div><div aria-labelledby="tab-1-1-1" class="sphinx-tabs-panel" hidden="true" id="panel-1-1-1" name="1-1" role="tabpanel" tabindex="0"><p>Sometimes it is very useful to be able to wait until a task has successfully initialized itself. For example, when starting network services, you can have your task start the listener and then signal the caller that initialization is done. That way, the caller can now start another task that depends on that service being up and running. Also, if the socket bind fails or something else goes wrong during initialization, the exception will be propagated to the caller which can then catch and handle it.</p>
<p>This can be done with <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start" title="anyio.abc.TaskGroup.start"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">TASK_STATUS_IGNORED</span><span class="p">,</span>
    <span class="n">create_task_group</span><span class="p">,</span>
    <span class="n">connect_tcp</span><span class="p">,</span>
    <span class="n">create_tcp_listener</span><span class="p">,</span>
    <span class="n">run</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">anyio.abc</span> <span class="kn">import</span> <span class="n">TaskStatus</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
    <span class="o">...</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">start_some_service</span><span class="p">(</span>
    <span class="n">port</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">task_status</span><span class="p">:</span> <span class="n">TaskStatus</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">TASK_STATUS_IGNORED</span>
<span class="p">):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">create_tcp_listener</span><span class="p">(</span>
        <span class="n">local_host</span><span class="o">=</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">local_port</span><span class="o">=</span><span class="n">port</span>
    <span class="p">)</span> <span class="k">as</span> <span class="n">listener</span><span class="p">:</span>
        <span class="n">task_status</span><span class="o">.</span><span class="n">started</span><span class="p">()</span>
        <span class="k">await</span> <span class="n">listener</span><span class="o">.</span><span class="n">serve</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="k">await</span> <span class="n">tg</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">start_some_service</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">with</span> <span class="k">await</span> <span class="n">connect_tcp</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="o">...</span>


<span class="n">run</span><span class="p">(</span><span class="n">main</span><span class="p">)</span>
</pre></div>
</div>
<p>The target coroutine function <strong>must</strong> call <code class="docutils literal notranslate"><span class="pre">task_status.started()</span></code> because the task that is calling with <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start" title="anyio.abc.TaskGroup.start"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start()</span></code></a> will be blocked until then. If the spawned task never calls it, then the <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start" title="anyio.abc.TaskGroup.start"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start()</span></code></a> call will raise a <code class="docutils literal notranslate"><span class="pre">RuntimeError</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Unlike <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start_soon" title="anyio.abc.TaskGroup.start_soon"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start_soon()</span></code></a>, <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start" title="anyio.abc.TaskGroup.start"><code class="xref py py-meth docutils literal notranslate"><span class="pre">start()</span></code></a> needs an <code class="docutils literal notranslate"><span class="pre">await</span></code>.</p>
</div>
</div></div>
</section>
<section id="id3">
<h2>处理任务组中的多个错误<a class="headerlink" href="#id3" title="Link to this heading">¶</a></h2>
<p><strong>Handling multiple errors in a task group</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-2-2-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-2-2-0" name="2-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-2-2-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-2-2-1" name="2-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-2-2-0" class="sphinx-tabs-panel" id="panel-2-2-0" name="2-0" role="tabpanel" tabindex="0"><p>在任务组中，多个任务可能会引发异常。当任务响应取消操作时，可能进入异常处理块或 <code class="docutils literal notranslate"><span class="pre">finally:</span></code> 块，并在此期间引发异常。这就引出了一个问题：哪个异常会从任务组上下文管理器中传播出来？答案是“两个”。实际上，这意味着会引发一个特殊的异常 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#ExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ExceptionGroup</span></code></a> （或 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#BaseExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">BaseExceptionGroup</span></code></a> ），其中包含了两个异常对象。</p>
<p>要捕获可能嵌套在组中的此类异常，需要采取特殊措施。在 Python 3.11 及更高版本中，可以使用 <code class="docutils literal notranslate"><span class="pre">except*</span></code> 语法来捕获多个异常:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_task_group</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">some_task</span><span class="p">)</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">another_task</span><span class="p">)</span>
<span class="k">except</span><span class="o">*</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">excgroup</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">excgroup</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># 处理每个 ValueError</span>
<span class="k">except</span><span class="o">*</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">excgroup</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">excgroup</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># 处理每个 KeyError</span>
</pre></div>
</div>
<p>如果需要兼容旧版本的 Python，可以使用 <a class="reference external" href="https://pypi.org/project/exceptiongroup/">exceptiongroup</a> 包中的 <code class="docutils literal notranslate"><span class="pre">catch()</span></code> 函数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_task_group</span>
<span class="kn">from</span> <span class="nn">exceptiongroup</span> <span class="kn">import</span> <span class="n">catch</span>

<span class="k">def</span> <span class="nf">handle_valueerror</span><span class="p">(</span><span class="n">excgroup</span><span class="p">:</span> <span class="n">ExceptionGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">excgroup</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># 处理每个 ValueError</span>

<span class="k">def</span> <span class="nf">handle_keyerror</span><span class="p">(</span><span class="n">excgroup</span><span class="p">:</span> <span class="n">ExceptionGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">excgroup</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># 处理每个 KeyError</span>

<span class="k">with</span> <span class="n">catch</span><span class="p">({</span>
    <span class="ne">ValueError</span><span class="p">:</span> <span class="n">handle_valueerror</span><span class="p">,</span>
    <span class="ne">KeyError</span><span class="p">:</span> <span class="n">handle_keyerror</span>
<span class="p">}):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">some_task</span><span class="p">)</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">another_task</span><span class="p">)</span>
</pre></div>
</div>
<p>如果需要在处理器中设置局部变量，可以将其声明为 <code class="docutils literal notranslate"><span class="pre">nonlocal</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">handle_valueerror</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
    <span class="k">nonlocal</span> <span class="n">somevariable</span>
    <span class="n">somevariable</span> <span class="o">=</span> <span class="s1">&#39;whatever&#39;</span>
</pre></div>
</div>
</div><div aria-labelledby="tab-2-2-1" class="sphinx-tabs-panel" hidden="true" id="panel-2-2-1" name="2-1" role="tabpanel" tabindex="0"><p>It is possible for more than one task to raise an exception in a task group. This can happen when a task reacts to cancellation by entering either an exception handler block or a <code class="docutils literal notranslate"><span class="pre">finally:</span></code> block and raises an exception there. This raises the question: which exception is propagated from the task group context manager? The answer is &quot;both&quot;. In practice this means that a special exception, <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#ExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">ExceptionGroup</span></code></a> (or <a class="reference external" href="https://docs.python.org/zh-cn/3/library/exceptions.html#BaseExceptionGroup" title="（在 Python v3.13）"><code class="xref py py-exc docutils literal notranslate"><span class="pre">BaseExceptionGroup</span></code></a>) is raised which contains both exception objects.</p>
<p>To catch such exceptions potentially nested in groups, special measures are required. On Python 3.11 and later, you can use the <code class="docutils literal notranslate"><span class="pre">except*</span></code> syntax to catch multiple exceptions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_task_group</span>

<span class="k">try</span><span class="p">:</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">some_task</span><span class="p">)</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">another_task</span><span class="p">)</span>
<span class="k">except</span><span class="o">*</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">excgroup</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">excgroup</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># handle each ValueError</span>
<span class="k">except</span><span class="o">*</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">excgroup</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">excgroup</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># handle each KeyError</span>
</pre></div>
</div>
<p>If compatibility with older Python versions is required, you can use the <code class="docutils literal notranslate"><span class="pre">catch()</span></code> function from the <a class="reference external" href="https://pypi.org/project/exceptiongroup/">exceptiongroup</a> package:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">anyio</span> <span class="kn">import</span> <span class="n">create_task_group</span>
<span class="kn">from</span> <span class="nn">exceptiongroup</span> <span class="kn">import</span> <span class="n">catch</span>

<span class="k">def</span> <span class="nf">handle_valueerror</span><span class="p">(</span><span class="n">excgroup</span><span class="p">:</span> <span class="n">ExceptionGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">excgroup</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># handle each ValueError</span>

<span class="k">def</span> <span class="nf">handle_keyerror</span><span class="p">(</span><span class="n">excgroup</span><span class="p">:</span> <span class="n">ExceptionGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">exc</span> <span class="ow">in</span> <span class="n">excgroup</span><span class="o">.</span><span class="n">exceptions</span><span class="p">:</span>
        <span class="o">...</span>  <span class="c1"># handle each KeyError</span>

<span class="k">with</span> <span class="n">catch</span><span class="p">({</span>
    <span class="ne">ValueError</span><span class="p">:</span> <span class="n">handle_valueerror</span><span class="p">,</span>
    <span class="ne">KeyError</span><span class="p">:</span> <span class="n">handle_keyerror</span>
<span class="p">}):</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">create_task_group</span><span class="p">()</span> <span class="k">as</span> <span class="n">tg</span><span class="p">:</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">some_task</span><span class="p">)</span>
        <span class="n">tg</span><span class="o">.</span><span class="n">start_soon</span><span class="p">(</span><span class="n">another_task</span><span class="p">)</span>
</pre></div>
</div>
<p>If you need to set local variables in the handlers, declare them as <code class="docutils literal notranslate"><span class="pre">nonlocal</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">handle_valueerror</span><span class="p">(</span><span class="n">exc</span><span class="p">):</span>
    <span class="k">nonlocal</span> <span class="n">somevariable</span>
    <span class="n">somevariable</span> <span class="o">=</span> <span class="s1">&#39;whatever&#39;</span>
</pre></div>
</div>
</div></div>
</section>
<section id="id4">
<h2>上下文传播<a class="headerlink" href="#id4" title="Link to this heading">¶</a></h2>
<p><strong>Context propagation</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-3-3-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-3-3-0" name="3-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-3-3-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-3-3-1" name="3-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-3-3-0" class="sphinx-tabs-panel" id="panel-3-3-0" name="3-0" role="tabpanel" tabindex="0"><p>每当生成一个新任务时，<a class="reference external" href="https://docs.python.org/3/library/contextvars.html">context</a> 将被复制到该新任务中。需要特别注意*哪个*上下文会被复制到新生成的任务中。被复制的不是任务组的宿主任务的上下文，而是调用 <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start" title="anyio.abc.TaskGroup.start"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start()</span></code></a> 或 <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start_soon" title="anyio.abc.TaskGroup.start_soon"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start_soon()</span></code></a> 的任务的上下文。</p>
</div><div aria-labelledby="tab-3-3-1" class="sphinx-tabs-panel" hidden="true" id="panel-3-3-1" name="3-1" role="tabpanel" tabindex="0"><p>Whenever a new task is spawned, <a class="reference external" href="https://docs.python.org/3/library/contextvars.html">context</a> will be copied to the new task. It is
important to note <em>which</em> context will be copied to the newly spawned task. It is not
the context of the task group's host task that will be copied, but the context of the
task that calls <a class="reference internal" href="api.html#anyio.abc.TaskGroup.start" title="anyio.abc.TaskGroup.start"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start()</span></code></a> or
<a class="reference internal" href="api.html#anyio.abc.TaskGroup.start_soon" title="anyio.abc.TaskGroup.start_soon"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TaskGroup.start_soon()</span></code></a>.</p>
</div></div>
</section>
<section id="asyncio-taskgroup">
<h2>与 asyncio.TaskGroup 的区别<a class="headerlink" href="#asyncio-taskgroup" title="Link to this heading">¶</a></h2>
<p><strong>Differences with asyncio.TaskGroup</strong></p>
<div class="sphinx-tabs docutils container">
<div aria-label="Tabbed content" class="closeable" role="tablist"><button aria-controls="panel-4-4-0" aria-selected="true" class="sphinx-tabs-tab" id="tab-4-4-0" name="4-0" role="tab" tabindex="0">中文</button><button aria-controls="panel-4-4-1" aria-selected="false" class="sphinx-tabs-tab" id="tab-4-4-1" name="4-1" role="tab" tabindex="-1">英文</button></div><div aria-labelledby="tab-4-4-0" class="sphinx-tabs-panel" id="panel-4-4-0" name="4-0" role="tabpanel" tabindex="0"><p><a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.TaskGroup" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">asyncio.TaskGroup</span></code></a> 类是在 Python 3.11 中新增的，其设计与 AnyIO 的 <a class="reference internal" href="api.html#anyio.abc.TaskGroup" title="anyio.abc.TaskGroup"><code class="xref py py-class docutils literal notranslate"><span class="pre">TaskGroup</span></code></a> 类非常相似。然而，asyncio 的对应类在语义上有一些重要的区别：</p>
<ul class="simple">
<li><p>任务组本身是直接实例化的，而不是通过工厂函数创建</p></li>
<li><p>任务仅通过 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.TaskGroup.create_task" title="（在 Python v3.13）"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_task()</span></code></a> 生成；没有 <code class="docutils literal notranslate"><span class="pre">start()</span></code> 或 <code class="docutils literal notranslate"><span class="pre">start_soon()</span></code> 方法</p></li>
<li><p><a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.TaskGroup.create_task" title="（在 Python v3.13）"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_task()</span></code></a> 方法返回一个任务对象，可以进行 <cite>await</cite> 操作（或取消）</p></li>
<li><p>通过 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.TaskGroup.create_task" title="（在 Python v3.13）"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_task()</span></code></a> 生成的任务只能单独取消（任务组中没有 <code class="docutils literal notranslate"><span class="pre">cancel()</span></code> 方法或类似的方法）</p></li>
<li><p>当通过 <a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.TaskGroup.create_task" title="（在 Python v3.13）"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_task()</span></code></a> 生成的任务在其协程开始运行之前被取消时，它将无法处理取消异常</p></li>
<li><p><a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.TaskGroup" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">asyncio.TaskGroup</span></code></a> 不允许在某个任务发生异常并触发任务组关闭后再启动新任务</p></li>
</ul>
</div><div aria-labelledby="tab-4-4-1" class="sphinx-tabs-panel" hidden="true" id="panel-4-4-1" name="4-1" role="tabpanel" tabindex="0"><p>The <a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.TaskGroup" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">asyncio.TaskGroup</span></code></a> class, added in Python 3.11, is very similar in design to
the AnyIO <a class="reference internal" href="api.html#anyio.abc.TaskGroup" title="anyio.abc.TaskGroup"><code class="xref py py-class docutils literal notranslate"><span class="pre">TaskGroup</span></code></a> class. The asyncio counterpart has some important
differences in its semantics, however:</p>
<ul class="simple">
<li><p>The task group itself is instantiated directly, rather than using a factory function</p></li>
<li><p>Tasks are spawned solely through <a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.TaskGroup.create_task" title="（在 Python v3.13）"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_task()</span></code></a>; there is no</p></li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">start()</span></code> or <code class="docutils literal notranslate"><span class="pre">start_soon()</span></code> method
* The <a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.TaskGroup.create_task" title="（在 Python v3.13）"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_task()</span></code></a> method returns a task object which can be
awaited on (or cancelled)
* Tasks spawned via <a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.TaskGroup.create_task" title="（在 Python v3.13）"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_task()</span></code></a> can only be cancelled
individually (there is no <code class="docutils literal notranslate"><span class="pre">cancel()</span></code> method or similar in the task group)
* When a task spawned via <a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.TaskGroup.create_task" title="（在 Python v3.13）"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_task()</span></code></a> is cancelled before its
coroutine has started running, it will not get a chance to handle the cancellation
exception
* <a class="reference external" href="https://docs.python.org/zh-cn/3/library/asyncio-task.html#asyncio.TaskGroup" title="（在 Python v3.13）"><code class="xref py py-class docutils literal notranslate"><span class="pre">asyncio.TaskGroup</span></code></a> does not allow starting new tasks after an exception in
one of the tasks has triggered a shutdown of the task group</p>
</div></div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="cancellation.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">取消和超时</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="basics.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">基础知识</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2018, Alex Grönholm
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/hellowac/anyio-zh-cn" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">创建和管理任务</a><ul>
<li><a class="reference internal" href="#id2">启动和初始化任务</a></li>
<li><a class="reference internal" href="#id3">处理任务组中的多个错误</a></li>
<li><a class="reference internal" href="#id4">上下文传播</a></li>
<li><a class="reference internal" href="#asyncio-taskgroup">与 asyncio.TaskGroup 的区别</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=b0668c51"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/translations.js?v=beaddf03"></script>
    <script src="_static/tabs.js?v=3030b3cb"></script>
    </body>
</html>